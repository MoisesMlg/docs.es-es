---
title: Configurar un entorno de generación de perfiles
ms.date: 03/30/2017
helpviewer_keywords:
- environment variables, profiling API
- profiling API [.NET Framework], setting up environment
- COR_PROFILER environment variable
- Windows Service applications, profiling
- profiling API [.NET Framework], Windows Service applications
- COR_ENABLE_PROFILING environment variable
- profiling API [.NET Framework], enabling
ms.assetid: fefca07f-7555-4e77-be86-3c542e928312
ms.openlocfilehash: 9c712c5efe8d6d79454b70d0bf4f3ca2fa83b637
ms.sourcegitcommit: d8020797a6657d0fbbdff362b80300815f682f94
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/24/2020
ms.locfileid: "95722484"
---
# <a name="setting-up-a-profiling-environment"></a><span data-ttu-id="3a962-102">Configurar un entorno de generación de perfiles</span><span class="sxs-lookup"><span data-stu-id="3a962-102">Setting Up a Profiling Environment</span></span>

> [!NOTE]
> <span data-ttu-id="3a962-103">Se han realizado cambios sustanciales en la generación de perfiles en el .NET Framework 4.</span><span class="sxs-lookup"><span data-stu-id="3a962-103">There have been substantial changes to profiling in the .NET Framework 4.</span></span>  
  
 <span data-ttu-id="3a962-104">Cuando se inicia un proceso administrado (aplicación o servicio), se carga el Common Language Runtime (CLR).</span><span class="sxs-lookup"><span data-stu-id="3a962-104">When a managed process (application or service) starts, it loads the common language runtime (CLR).</span></span> <span data-ttu-id="3a962-105">Cuando se inicializa el CLR, evalúa las siguientes dos variables de entorno para decidir si el proceso debería conectar con un generador de perfiles:</span><span class="sxs-lookup"><span data-stu-id="3a962-105">When the CLR is initialized, it evaluates the following two environmental variables to decide whether the process should connect to a profiler:</span></span>  
  
- <span data-ttu-id="3a962-106">COR_ENABLE_PROFILING: CLR solamente se conecta a un generador de perfiles si esta variable de entorno existe y está establecida en 1.</span><span class="sxs-lookup"><span data-stu-id="3a962-106">COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.</span></span>  
  
- <span data-ttu-id="3a962-107">COR_PROFILER: si la comprobación de COR_ENABLE_PROFILING es correcta, CLR conecta con el generador de perfiles que tiene este CLSID o ProgID, que se debe haber almacenado previamente en el Registro.</span><span class="sxs-lookup"><span data-stu-id="3a962-107">COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry.</span></span> <span data-ttu-id="3a962-108">La variable de entorno COR_PROFILER se define como una cadena, como se muestra en los dos ejemplos siguientes.</span><span class="sxs-lookup"><span data-stu-id="3a962-108">The COR_PROFILER environment variable is defined as a string, as shown in the following two examples.</span></span>  
  
    ```cpp  
    set COR_PROFILER={32E2F4DA-1BEA-47ea-88F9-C5DAF691C94A}  
    set COR_PROFILER="MyProfiler"  
    ```  
  
 <span data-ttu-id="3a962-109">Para generar el perfil de una aplicación CLR, debe establecer las variables de entorno COR_PROFILER y COR_ENABLE_PROFILING antes de ejecutar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="3a962-109">To profile a CLR application, you must set the COR_ENABLE_PROFILING and COR_PROFILER environment variables before you run the application.</span></span> <span data-ttu-id="3a962-110">También debe asegurarse de que se haya registrado la DLL del generador de perfiles.</span><span class="sxs-lookup"><span data-stu-id="3a962-110">You must also make sure that the profiler DLL is registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="3a962-111">A partir de la .NET Framework 4, no es necesario registrar los perfiles.</span><span class="sxs-lookup"><span data-stu-id="3a962-111">Starting with the .NET Framework 4, profilers do not have to be registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="3a962-112">Para usar .NET Framework las versiones 2,0, 3,0 y 3,5 en el .NET Framework 4 y versiones posteriores, debe establecer la variable de entorno COMPLUS_ProfAPI_ProfilerCompatibilitySetting.</span><span class="sxs-lookup"><span data-stu-id="3a962-112">To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the .NET Framework 4 and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.</span></span>  
  
## <a name="environment-variable-scope"></a><span data-ttu-id="3a962-113">Ámbito de la variable de entorno</span><span class="sxs-lookup"><span data-stu-id="3a962-113">Environment Variable Scope</span></span>  

 <span data-ttu-id="3a962-114">La forma de establecer las variables de entorno COR_PROFILER y COR_ENABLE_PROFILING determina su ámbito de influencia.</span><span class="sxs-lookup"><span data-stu-id="3a962-114">How you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables will determine their scope of influence.</span></span> <span data-ttu-id="3a962-115">Puede establecer estas variables una de las siguientes maneras:</span><span class="sxs-lookup"><span data-stu-id="3a962-115">You can set these variables in one of the following ways:</span></span>  
  
- <span data-ttu-id="3a962-116">Si establece las variables en una llamada [ICorDebug:: CreateProcess](../debugging/icordebug-createprocess-method.md) , solo se aplicarán a la aplicación que está ejecutando en ese momento.</span><span class="sxs-lookup"><span data-stu-id="3a962-116">If you set the variables in an [ICorDebug::CreateProcess](../debugging/icordebug-createprocess-method.md) call, they will apply only to the application that you are running at the time.</span></span> <span data-ttu-id="3a962-117">(También se aplicarán a otras aplicaciones iniciadas por esa aplicación que hereden el entorno.)</span><span class="sxs-lookup"><span data-stu-id="3a962-117">(They will also apply to other applications started by that application that inherit the environment.)</span></span>  
  
- <span data-ttu-id="3a962-118">Si establece las variables en una ventana del símbolo del sistema, se aplicarán a todas las aplicaciones iniciadas desde esa ventana.</span><span class="sxs-lookup"><span data-stu-id="3a962-118">If you set the variables in a Command Prompt window, they will apply to all applications that are started from that window.</span></span>  
  
- <span data-ttu-id="3a962-119">Si establece las variables en el nivel de usuario, se aplicarán a todas las aplicaciones que inicie con el Explorador de archivos.</span><span class="sxs-lookup"><span data-stu-id="3a962-119">If you set the variables at the user level, they will apply to all applications that you start with File Explorer.</span></span> <span data-ttu-id="3a962-120">Una ventana del símbolo del sistema que abra después de establecer las variables tendrá esta configuración de entorno, y también la tendrán todas las aplicaciones que inicie desde esa ventana.</span><span class="sxs-lookup"><span data-stu-id="3a962-120">A Command Prompt window that you open after you set the variables will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="3a962-121">Para establecer variables de entorno en el nivel de usuario, haga clic con el botón secundario en **mi PC**, haga clic en **propiedades**, haga clic en la pestaña **Opciones avanzadas** , haga clic en **variables de entorno** y agregue las variables a la lista variables de **usuario** .</span><span class="sxs-lookup"><span data-stu-id="3a962-121">To set environment variables at the user level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, and add the variables to the **User variables** list.</span></span>  
  
- <span data-ttu-id="3a962-122">Si establece las variables en el nivel de equipo, se aplicarán a todas las aplicaciones que se inicien en ese equipo.</span><span class="sxs-lookup"><span data-stu-id="3a962-122">If you set the variables at the computer level, they will apply to all applications that are started on that computer.</span></span> <span data-ttu-id="3a962-123">Una ventana del símbolo del sistema que abra en ese equipo tendrá esta configuración de entorno, y también la tendrán todas las aplicaciones que inicie desde esa ventana.</span><span class="sxs-lookup"><span data-stu-id="3a962-123">A Command Prompt window that you open on that computer will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="3a962-124">Esto significa que todos los procesos administrados de ese equipo se iniciarán con el generador de perfiles.</span><span class="sxs-lookup"><span data-stu-id="3a962-124">This means that every managed process on that computer will start with your profiler.</span></span> <span data-ttu-id="3a962-125">Para establecer variables de entorno en el nivel de equipo, haga clic con el botón secundario en **mi PC**, haga clic en **propiedades**, haga clic en la pestaña **Opciones avanzadas** , haga clic en **variables de entorno**, agregue las variables a la lista **variables del sistema** y, a continuación, reinicie el equipo.</span><span class="sxs-lookup"><span data-stu-id="3a962-125">To set environment variables at the computer level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, add the variables to the **System variables** list, and then restart your computer.</span></span> <span data-ttu-id="3a962-126">Después de reiniciar, las variables estarán disponibles para todo el sistema.</span><span class="sxs-lookup"><span data-stu-id="3a962-126">After restarting, the variables will be available system-wide.</span></span>  
  
 <span data-ttu-id="3a962-127">Si está generando perfiles para un servicio de Windows, debe reiniciar el equipo después de establecer las variables de entorno y registrar la DLL del generador de perfiles.</span><span class="sxs-lookup"><span data-stu-id="3a962-127">If you are profiling a Windows Service, you must restart your computer after you set the environment variables and register the profiler DLL.</span></span> <span data-ttu-id="3a962-128">Para obtener más información sobre estas consideraciones, consulte la sección [generación de perfiles de un servicio de Windows](#windows_service).</span><span class="sxs-lookup"><span data-stu-id="3a962-128">For more information about these considerations, see the section [Profiling a Windows Service](#windows_service).</span></span>  
  
## <a name="additional-considerations"></a><span data-ttu-id="3a962-129">Consideraciones adicionales</span><span class="sxs-lookup"><span data-stu-id="3a962-129">Additional Considerations</span></span>  
  
- <span data-ttu-id="3a962-130">La clase Profiler implementa las interfaces [ICorProfilerCallback](icorprofilercallback-interface.md) e [ICorProfilerCallback2](icorprofilercallback2-interface.md) .</span><span class="sxs-lookup"><span data-stu-id="3a962-130">The profiler class implements the [ICorProfilerCallback](icorprofilercallback-interface.md) and [ICorProfilerCallback2](icorprofilercallback2-interface.md) interfaces.</span></span> <span data-ttu-id="3a962-131">En la versión 2.0 de .NET Framework, un generador de perfiles debe implementar `ICorProfilerCallback2`.</span><span class="sxs-lookup"><span data-stu-id="3a962-131">In the .NET Framework version 2.0, a profiler must implement `ICorProfilerCallback2`.</span></span> <span data-ttu-id="3a962-132">Si no lo hace, no se cargará `ICorProfilerCallback2`.</span><span class="sxs-lookup"><span data-stu-id="3a962-132">If it does not, `ICorProfilerCallback2` will not be loaded.</span></span>  
  
- <span data-ttu-id="3a962-133">Solamente un generador de perfiles puede generar un perfil en cada momento en un entorno determinado.</span><span class="sxs-lookup"><span data-stu-id="3a962-133">Only one profiler can profile a process at one time in a given environment.</span></span> <span data-ttu-id="3a962-134">Puede registrar dos generadores de perfiles diferentes en entornos diferentes, pero cada uno debe actuar en procesos independientes.</span><span class="sxs-lookup"><span data-stu-id="3a962-134">You can register two different profilers in different environments, but each must profile separate processes.</span></span> <span data-ttu-id="3a962-135">El generador de perfiles se debe implementar como una DLL del servidor COM en proceso, que está asignada al mismo espacio de direcciones que el proceso que se está perfilando.</span><span class="sxs-lookup"><span data-stu-id="3a962-135">The profiler must be implemented as an in-process COM server DLL, which is mapped into the same address space as the process that is being profiled.</span></span> <span data-ttu-id="3a962-136">Esto significa que el generador de perfiles se ejecuta en proceso.</span><span class="sxs-lookup"><span data-stu-id="3a962-136">This means that the profiler runs in-process.</span></span> <span data-ttu-id="3a962-137">.NET Framework no es compatible con ningún otro tipo de servidor COM.</span><span class="sxs-lookup"><span data-stu-id="3a962-137">The .NET Framework does not support any other type of COM server.</span></span> <span data-ttu-id="3a962-138">Por ejemplo, si un generador de perfiles desea supervisar aplicaciones desde un equipo remoto, debe implementar agentes recolectores en cada PC.</span><span class="sxs-lookup"><span data-stu-id="3a962-138">For example, if a profiler wants to monitor applications from a remote computer, it must implement collector agents on each computer.</span></span> <span data-ttu-id="3a962-139">Estos agentes generarán resultados por lotes y los comunicarán al equipo central de recolección de datos.</span><span class="sxs-lookup"><span data-stu-id="3a962-139">These agents will batch results and communicate them to the central data collection computer.</span></span>  
  
- <span data-ttu-id="3a962-140">Dado que el generador de perfiles es un objeto COM del que se crean instancias en proceso, cada aplicación para la que se generen perfiles tendrá su propia copia del generador de perfiles.</span><span class="sxs-lookup"><span data-stu-id="3a962-140">Because the profiler is a COM object that is instantiated in-process, each profiled application will have its own copy of the profiler.</span></span> <span data-ttu-id="3a962-141">Por consiguiente, una instancia única del generador de perfiles no tiene que administrar datos de varias aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="3a962-141">Therefore, a single profiler instance does not have to handle data from multiple applications.</span></span> <span data-ttu-id="3a962-142">Sin embargo, tendrá que agregar lógica al código de registro del generador de perfiles para evitar que el archivo de registro sobrescriba otras aplicaciones para las que se haya generado perfiles.</span><span class="sxs-lookup"><span data-stu-id="3a962-142">However, you will have to add logic to the profiler's logging code to prevent log file overwrites from other profiled applications.</span></span>  
  
## <a name="initializing-the-profiler"></a><span data-ttu-id="3a962-143">Inicializar el generador de perfiles</span><span class="sxs-lookup"><span data-stu-id="3a962-143">Initializing the Profiler</span></span>  

 <span data-ttu-id="3a962-144">Cuando ambas comprobaciones de variables de entorno se realizan correctamente, CLR crea una instancia del generador de perfiles de una manera similar a la función COM `CoCreateInstance`.</span><span class="sxs-lookup"><span data-stu-id="3a962-144">When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM `CoCreateInstance` function.</span></span> <span data-ttu-id="3a962-145">El generador de perfiles no se carga mediante una llamada directa a `CoCreateInstance`.</span><span class="sxs-lookup"><span data-stu-id="3a962-145">The profiler is not loaded through a direct call to `CoCreateInstance`.</span></span> <span data-ttu-id="3a962-146">Por consiguiente, se evita una llamada a `CoInitialize`, que requiere la configuración del modelo de subprocesos.</span><span class="sxs-lookup"><span data-stu-id="3a962-146">Therefore, a call to `CoInitialize`, which requires setting the threading model, is avoided.</span></span> <span data-ttu-id="3a962-147">A continuación, CLR llama al método [ICorProfilerCallback:: Initialize](icorprofilercallback-initialize-method.md) en el generador de perfiles.</span><span class="sxs-lookup"><span data-stu-id="3a962-147">The CLR then calls the [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) method in the profiler.</span></span> <span data-ttu-id="3a962-148">La firma de este método es como sigue.</span><span class="sxs-lookup"><span data-stu-id="3a962-148">The signature of this method is as follows.</span></span>  
  
```cpp  
HRESULT Initialize(IUnknown *pICorProfilerInfoUnk)  
```  
  
 <span data-ttu-id="3a962-149">El generador de perfiles debe consultar `pICorProfilerInfoUnk` un puntero de interfaz [ICorProfilerInfo](icorprofilerinfo-interface.md) o [ICorProfilerInfo2](icorprofilerinfo2-interface.md) y guardarlo para que pueda solicitar más información más adelante durante la generación de perfiles.</span><span class="sxs-lookup"><span data-stu-id="3a962-149">The profiler must query `pICorProfilerInfoUnk` for an [ICorProfilerInfo](icorprofilerinfo-interface.md) or [ICorProfilerInfo2](icorprofilerinfo2-interface.md) interface pointer and save it so that it can request more information later during profiling.</span></span>  
  
## <a name="setting-event-notifications"></a><span data-ttu-id="3a962-150">Establecer notificaciones de eventos</span><span class="sxs-lookup"><span data-stu-id="3a962-150">Setting Event Notifications</span></span>  

 <span data-ttu-id="3a962-151">Después, el generador de perfiles llama al método [ICorProfilerInfo:: SetEventMask](icorprofilerinfo-seteventmask-method.md) para especificar las categorías de notificaciones en las que está interesado.</span><span class="sxs-lookup"><span data-stu-id="3a962-151">The profiler then calls the [ICorProfilerInfo::SetEventMask](icorprofilerinfo-seteventmask-method.md) method to specify which categories of notifications it is interested in.</span></span> <span data-ttu-id="3a962-152">Por ejemplo, si el generador de perfiles solamente está interesado en notificaciones de entrada y salida de funciones y notificaciones de recolección de elementos no utilizados, especifica lo siguiente.</span><span class="sxs-lookup"><span data-stu-id="3a962-152">For example, if the profiler is interested only in function enter and leave notifications and garbage collection notifications, it specifies the following.</span></span>  
  
```cpp  
ICorProfilerInfo* pInfo;  
pICorProfilerInfoUnk->QueryInterface(IID_ICorProfilerInfo, (void**)&pInfo);  
pInfo->SetEventMask(COR_PRF_MONITOR_ENTERLEAVE | COR_PRF_MONITOR_GC)  
```  
  
 <span data-ttu-id="3a962-153">Estableciendo la máscara de notificaciones de esta manera, el generador de perfiles puede limitar qué notificaciones recibe.</span><span class="sxs-lookup"><span data-stu-id="3a962-153">By setting the notifications mask in this manner, the profiler can limit which notifications it receives.</span></span> <span data-ttu-id="3a962-154">Este enfoque ayuda al usuario a compilar un generador de perfiles simple o de propósito especial.</span><span class="sxs-lookup"><span data-stu-id="3a962-154">This approach helps the user build a simple or special-purpose profiler.</span></span> <span data-ttu-id="3a962-155">También reduce tiempo de CPU que se gastaría enviando notificaciones que el generador de perfiles simplemente omitiría.</span><span class="sxs-lookup"><span data-stu-id="3a962-155">It also reduces CPU time that would be wasted sending notifications that the profiler would just ignore.</span></span>  
  
 <span data-ttu-id="3a962-156">Ciertos eventos del generador de perfiles son inmutables.</span><span class="sxs-lookup"><span data-stu-id="3a962-156">Certain profiler events are immutable.</span></span> <span data-ttu-id="3a962-157">Esto significa que, tan pronto como se establezcan estos eventos en la devolución de llamada `ICorProfilerCallback::Initialize`, no se pueden desactivar y no es posible activar nuevos eventos.</span><span class="sxs-lookup"><span data-stu-id="3a962-157">This means that as soon as these events are set in the `ICorProfilerCallback::Initialize` callback, they cannot be turned off and new events cannot be turned on.</span></span> <span data-ttu-id="3a962-158">Los intentos de modificar un evento inmutable provocarán que `ICorProfilerInfo::SetEventMask` devuelva un HRESULT fallido.</span><span class="sxs-lookup"><span data-stu-id="3a962-158">Attempts to change an immutable event will result in `ICorProfilerInfo::SetEventMask` returning a failed HRESULT.</span></span>  
  
<a name="windows_service"></a>

## <a name="profiling-a-windows-service"></a><span data-ttu-id="3a962-159">Generar perfiles en un servicio de Windows</span><span class="sxs-lookup"><span data-stu-id="3a962-159">Profiling a Windows Service</span></span>  

 <span data-ttu-id="3a962-160">La generación de perfiles de Servicio de Windows es similar a la generación de perfiles para una aplicación de Common Language Runtime.</span><span class="sxs-lookup"><span data-stu-id="3a962-160">Profiling a Windows Service is like profiling a common language runtime application.</span></span> <span data-ttu-id="3a962-161">Ambas operaciones de generación de perfiles se habilitan mediante variables de entorno.</span><span class="sxs-lookup"><span data-stu-id="3a962-161">Both profiling operations are enabled through environment variables.</span></span> <span data-ttu-id="3a962-162">Dado que un Servicio de Windows se inicia cuando se inicia el sistema operativo, las variables de entorno que se explican anteriormente en este tema deben estar ya presentes y establecidas en los valores necesarios antes de que se inicie el sistema.</span><span class="sxs-lookup"><span data-stu-id="3a962-162">Because a Windows Service is started when the operating system starts, the environment variables discussed previously in this topic must already be present and set to the required values before the system starts.</span></span> <span data-ttu-id="3a962-163">Además, la DLL de generación de perfiles debe estar ya registrada en el sistema.</span><span class="sxs-lookup"><span data-stu-id="3a962-163">In addition, the profiling DLL must already be registered on the system.</span></span>  
  
 <span data-ttu-id="3a962-164">Después de establecer las variables de entorno COR_PROFILER y COR_ENABLE_PROFILING, y de registrar la DLL del generador de perfiles, debe reiniciarse el equipo de destino para que el Servicio de Windows pueda detectar esos cambios.</span><span class="sxs-lookup"><span data-stu-id="3a962-164">After you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables and register the profiler DLL, you should restart the target computer so that the Windows Service can detect those changes.</span></span>  
  
 <span data-ttu-id="3a962-165">Observe que estos cambios habilitarán la generación de perfiles para todo el sistema.</span><span class="sxs-lookup"><span data-stu-id="3a962-165">Note that these changes will enable profiling on a system-wide basis.</span></span> <span data-ttu-id="3a962-166">Para evitar que se generen perfiles para cada aplicación administrada que se ejecute a continuación, debe eliminar las variables de entorno del sistema después de reiniciar el equipo de destino.</span><span class="sxs-lookup"><span data-stu-id="3a962-166">To prevent every managed application that subsequently runs from being profiled, you should delete the system environment variables after you restart the target computer.</span></span>  
  
 <span data-ttu-id="3a962-167">Esta técnica también provoca que se generen perfiles para todos los procesos de CLR.</span><span class="sxs-lookup"><span data-stu-id="3a962-167">This technique also leads to every CLR process getting profiled.</span></span> <span data-ttu-id="3a962-168">El generador de perfiles debe agregar lógica a su devolución de llamada [ICorProfilerCallback:: Initialize](icorprofilercallback-initialize-method.md) para detectar si el proceso actual es de interés.</span><span class="sxs-lookup"><span data-stu-id="3a962-168">The profiler should add logic to its [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) callback to detect whether the current process is of interest.</span></span> <span data-ttu-id="3a962-169">Si no es así, el generador de perfiles puede producir un error en la devolución de llamada sin realizar la inicialización.</span><span class="sxs-lookup"><span data-stu-id="3a962-169">If it is not, the profiler can fail the callback without performing the initialization.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="3a962-170">Consulte también</span><span class="sxs-lookup"><span data-stu-id="3a962-170">See also</span></span>

- [<span data-ttu-id="3a962-171">Información general sobre la generación de perfiles</span><span class="sxs-lookup"><span data-stu-id="3a962-171">Profiling Overview</span></span>](profiling-overview.md)
