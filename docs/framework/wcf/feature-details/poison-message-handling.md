---
title: Control de mensajes dudosos
ms.date: 03/30/2017
ms.assetid: 8d1c5e5a-7928-4a80-95ed-d8da211b8595
ms.openlocfilehash: 9aeb404cea18a7dd6a9c416c0728d9905c0d782d
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/26/2020
ms.locfileid: "96244826"
---
# <a name="poison-message-handling"></a><span data-ttu-id="ec1c0-102">Control de mensajes dudosos</span><span class="sxs-lookup"><span data-stu-id="ec1c0-102">Poison Message Handling</span></span>

<span data-ttu-id="ec1c0-103">Un *mensaje dudoso* es un mensaje que ha superado el número máximo de intentos de entrega a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-103">A *poison message* is a message that has exceeded the maximum number of delivery attempts to the application.</span></span> <span data-ttu-id="ec1c0-104">Esta situación se puede presentar cuando una aplicación basada en cola no puede procesar un mensaje debido a los errores.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-104">This situation can arise when a queue-based application cannot process a message because of errors.</span></span> <span data-ttu-id="ec1c0-105">Para satisfacer la confiabilidad que exige, una aplicación en cola recibe los mensajes bajo una transacción.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-105">To meet reliability demands, a queued application receives messages under a transaction.</span></span> <span data-ttu-id="ec1c0-106">Anular la transacción en la que un mensaje en cola se recibió deja el mensaje en la cola para que el mensaje se vuelva a intentar con una nueva transacción.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-106">Aborting the transaction in which a queued message was received leaves the message in the queue so that the message is retried under a new transaction.</span></span> <span data-ttu-id="ec1c0-107">Si no se corrige el problema que produjo la anulación de la transacción, la aplicación receptora se puede atascar en una recepción de bucle y anulando el mismo mensaje hasta que supere el número máximo de intentos de entrega, y se produzca un mensaje dudoso.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-107">If the problem that caused the transaction to abort is not corrected, the receiving application can get stuck in a loop receiving and aborting the same message until the maximum number of delivery attempts has been exceeded and a poison message results.</span></span>  
  
 <span data-ttu-id="ec1c0-108">Un mensaje se puede volver un mensaje dudoso por muchas razones.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-108">A message can become a poison message for many reasons.</span></span> <span data-ttu-id="ec1c0-109">Las razones más comunes son específicas de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-109">The most common reasons are application-specific.</span></span> <span data-ttu-id="ec1c0-110">Por ejemplo, si una aplicación lee un mensaje de una cola y realiza algún procesamiento de base de datos, es posible que la aplicación no pueda obtener un bloqueo en la base de datos, haciendo que se anule la transacción.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-110">For example, if an application reads a message from a queue and performs some database processing, the application may fail to get a lock on the database, causing it to abort the transaction.</span></span> <span data-ttu-id="ec1c0-111">Dado que la transacción de base de datos se anula, el mensaje permanece en la cola, lo que hace que la aplicación vuelva a leer el mensaje una segunda vez y realice otro intento de adquirir un bloqueo en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-111">Because the database transaction was aborted, the message remains in the queue, which causes the application to reread the message a second time and make another attempt to acquire a lock on the database.</span></span> <span data-ttu-id="ec1c0-112">Los mensajes también se pueden volver dudosos si contienen la información no válida.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-112">Messages can also become poison if they contain invalid information.</span></span> <span data-ttu-id="ec1c0-113">Por ejemplo, un pedido de compra puede contener un número del cliente no válido.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-113">For example, a purchase order may contain an invalid customer number.</span></span> <span data-ttu-id="ec1c0-114">En estos casos, la aplicación puede anular voluntariamente la transacción y forzar al mensaje a convertirse en un mensaje dudoso.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-114">In these cases, the application may voluntarily abort the transaction and force the message to become a poison message.</span></span>  
  
 <span data-ttu-id="ec1c0-115">En raras ocasiones, se puede producir un error en la distribución a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-115">On rare occasions, messages can fail to get dispatched to the application.</span></span> <span data-ttu-id="ec1c0-116">La capa Windows Communication Foundation (WCF) puede encontrar un problema con el mensaje, por ejemplo, si el mensaje tiene un marco incorrecto, credenciales de mensaje no válidas adjuntas a él o un encabezado de acción no válido.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-116">The Windows Communication Foundation (WCF) layer may find a problem with the message, such as if the message has the wrong frame, invalid message credentials attached to it, or an invalid action header.</span></span> <span data-ttu-id="ec1c0-117">En estos casos, la aplicación nunca recibe el mensaje; sin embargo, el mensaje todavía se puede convertir en un mensaje dudoso y procesar manualmente.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-117">In these cases, the application never receives the message; however, the message can still become a poison message and be processed manually.</span></span>  
  
## <a name="handling-poison-messages"></a><span data-ttu-id="ec1c0-118">Control de mensajes dudosos</span><span class="sxs-lookup"><span data-stu-id="ec1c0-118">Handling Poison Messages</span></span>  

 <span data-ttu-id="ec1c0-119">En WCF, el control de mensajes dudosos proporciona un mecanismo para que una aplicación receptora trate los mensajes que no se pueden enviar a la aplicación o los mensajes que se envían a la aplicación, pero que no se pueden procesar debido a razones específicas de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-119">In WCF, poison message handling provides a mechanism for a receiving application to deal with messages that cannot be dispatched to the application or messages that are dispatched to the application but that fail to be processed because of application-specific reasons.</span></span> <span data-ttu-id="ec1c0-120">Configure el control de mensajes dudosos con las propiedades siguientes en cada uno de los enlaces en cola disponibles:</span><span class="sxs-lookup"><span data-stu-id="ec1c0-120">Configure poison message handling with the following properties in each of the available queued bindings:</span></span>  
  
- <span data-ttu-id="ec1c0-121">`ReceiveRetryCount`.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-121">`ReceiveRetryCount`.</span></span> <span data-ttu-id="ec1c0-122">Un valor entero que indica el número máximo de horas para reintentar la entrega de un mensaje de la cola de la aplicación a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-122">An integer value that indicates the maximum number of times to retry delivery of a message from the application queue to the application.</span></span> <span data-ttu-id="ec1c0-123">El valor predeterminado es 5.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-123">The default value is 5.</span></span> <span data-ttu-id="ec1c0-124">Esto es suficiente en casos donde un reintento inmediato corrige el problema, como ocurre con un interbloqueo temporal en una base de datos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-124">This is sufficient in cases where an immediate retry fixes the problem, such as with a temporary deadlock on a database.</span></span>  
  
- <span data-ttu-id="ec1c0-125">`MaxRetryCycles`.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-125">`MaxRetryCycles`.</span></span> <span data-ttu-id="ec1c0-126">Un valor entero que indica el número máximo de ciclos de reintento.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-126">An integer value that indicates the maximum number of retry cycles.</span></span> <span data-ttu-id="ec1c0-127">Un ciclo de reintento consiste en transferir un mensaje de la cola de la aplicación a una subcola de intento y, después de un retraso configurable, de la subcola de intento de vuelta a la cola de la aplicación para reintentar la entrega.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-127">A retry cycle consists of transferring a message from the application queue to the retry subqueue and, after a configurable delay, from the retry subqueue back into the application queue to reattempt delivery.</span></span> <span data-ttu-id="ec1c0-128">El valor predeterminado es 2.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-128">The default value is 2.</span></span> <span data-ttu-id="ec1c0-129">En Windows Vista, el mensaje se prueba un máximo de ( `ReceiveRetryCount` + 1) \* ( `MaxRetryCycles` + 1) veces.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-129">On Windows Vista, the message is tried a maximum of (`ReceiveRetryCount` +1) \* (`MaxRetryCycles` + 1) times.</span></span> <span data-ttu-id="ec1c0-130">`MaxRetryCycles` se omite en Windows Server 2003 y Windows XP.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-130">`MaxRetryCycles` is ignored on Windows Server 2003 and Windows XP.</span></span>  
  
- <span data-ttu-id="ec1c0-131">`RetryCycleDelay`.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-131">`RetryCycleDelay`.</span></span> <span data-ttu-id="ec1c0-132">El tiempo de retardo entre los ciclos de reintento.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-132">The time delay between retry cycles.</span></span> <span data-ttu-id="ec1c0-133">El valor predeterminado es de 30 minutos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-133">The default value is 30 minutes.</span></span> <span data-ttu-id="ec1c0-134">`MaxRetryCycles` y `RetryCycleDelay` proporcionan juntos un mecanismo para resolver el problema donde un reintento después de un retraso periódico corrige el problema.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-134">`MaxRetryCycles` and `RetryCycleDelay` together provide a mechanism to address the problem where a retry after a periodic delay fixes the problem.</span></span> <span data-ttu-id="ec1c0-135">Por ejemplo, esto controla un conjunto de filas bloqueado en confirmación de la transacción pendiente de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-135">For example, this handles a locked row set in SQL Server pending transaction commit.</span></span>  
  
- <span data-ttu-id="ec1c0-136">`ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-136">`ReceiveErrorHandling`.</span></span> <span data-ttu-id="ec1c0-137">Una enumeración que indica la acción a realizar para un mensaje en el que se ha producido un error tras intentar el número máximo de reintentos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-137">An enumeration that indicates the action to take for a message that has failed delivery after the maximum number of retries has been attempted.</span></span> <span data-ttu-id="ec1c0-138">Los valores pueden ser Fault, Drop, Reject, y Move.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-138">The values can be Fault, Drop, Reject, and Move.</span></span> <span data-ttu-id="ec1c0-139">La opción de unidad predeterminada es Fault.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-139">The default option is Fault.</span></span>  
  
- <span data-ttu-id="ec1c0-140">Fault.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-140">Fault.</span></span> <span data-ttu-id="ec1c0-141">Esta opción envía un error al agente de escucha que provocó el error en `ServiceHost`.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-141">This option sends a fault to the listener that caused the `ServiceHost` to fault.</span></span> <span data-ttu-id="ec1c0-142">El mensaje debe ser eliminado de la cola de la aplicación por algún mecanismo externo antes de que la aplicación pueda continuar procesando los mensajes de la cola.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-142">The message must be removed from the application queue by some external mechanism before the application can continue to process messages from the queue.</span></span>  
  
- <span data-ttu-id="ec1c0-143">Drop.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-143">Drop.</span></span> <span data-ttu-id="ec1c0-144">Esta opción quita el mensaje dudoso y el mensaje nunca llega a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-144">This option drops the poison message and the message is never delivered to the application.</span></span> <span data-ttu-id="ec1c0-145">Si la propiedad `TimeToLive` del mensaje ha expirado en este punto, el mensaje puede aparecer en la cola de mensajes no enviados del remitente.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-145">If the message's `TimeToLive` property has expired at this point, then the message may appear in the sender's dead-letter queue.</span></span> <span data-ttu-id="ec1c0-146">Si no, el mensaje no aparece en ningún sitio.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-146">If not, the message does not appear anywhere.</span></span> <span data-ttu-id="ec1c0-147">Esta opción indica que el usuario no ha especificado qué hacer si se pierde el mensaje.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-147">This option indicates that the user has not specified what to do if the message is lost.</span></span>  
  
- <span data-ttu-id="ec1c0-148">Reject.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-148">Reject.</span></span> <span data-ttu-id="ec1c0-149">Esta opción solo está disponible en Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-149">This option is available only on Windows Vista.</span></span> <span data-ttu-id="ec1c0-150">Esto indica a Message Queuing (MSMQ) que envíe una confirmación negativa de vuelta al administrador de la cola emisora que la aplicación no puede recibir el mensaje.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-150">This instructs Message Queuing (MSMQ) to send a negative acknowledgment back to the sending queue manager that the application cannot receive the message.</span></span> <span data-ttu-id="ec1c0-151">El mensaje se coloca en la cola de mensajes no enviados del administrador de la cola emisora.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-151">The message is placed in the sending queue manager's dead-letter queue.</span></span>  
  
- <span data-ttu-id="ec1c0-152">Move.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-152">Move.</span></span> <span data-ttu-id="ec1c0-153">Esta opción solo está disponible en Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-153">This option is available only on Windows Vista.</span></span> <span data-ttu-id="ec1c0-154">Mueve el mensaje dudoso a una cola de mensajes dudosos para ser procesado posteriormente por una aplicación de control de mensajes dudosos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-154">This moves the poison message to a poison-message queue for later processing by a poison-message handling application.</span></span> <span data-ttu-id="ec1c0-155">La cola de mensajes dudosos es una subcola de la cola de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-155">The poison-message queue is a subqueue of the application queue.</span></span> <span data-ttu-id="ec1c0-156">Una aplicación de control de mensajes dudosos puede ser un servicio WCF que lee los mensajes de la cola de mensajes dudosos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-156">A poison-message handling application can be a WCF service that reads messages out of the poison queue.</span></span> <span data-ttu-id="ec1c0-157">La cola de mensajes dudosos es una subcola de la cola de la aplicación y se puede direccionar como net. MSMQ:// \<*machine-name*> / *applicationQueue*;p Oison, donde *Machine-Name* es el nombre del equipo en el que reside la cola y *applicationQueue* es el nombre de la cola específica de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-157">The poison queue is a subqueue of the application queue and can be addressed as net.msmq://\<*machine-name*>/*applicationQueue*;poison, where *machine-name* is the name of the computer on which the queue resides and the *applicationQueue* is the name of the application-specific queue.</span></span>  
  
<span data-ttu-id="ec1c0-158">A continuación, se muestra el número máximo de intentos de entrega realizados para un mensaje:</span><span class="sxs-lookup"><span data-stu-id="ec1c0-158">The following are the maximum number of delivery attempts made for a message:</span></span>  
  
- <span data-ttu-id="ec1c0-159">((ReceiveRetryCount + 1) \* (MaxRetryCycles + 1)) en Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-159">((ReceiveRetryCount+1) \* (MaxRetryCycles + 1)) on Windows Vista.</span></span>  
  
- <span data-ttu-id="ec1c0-160">(ReceiveRetryCount + 1) en Windows Server 2003 y Windows XP.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-160">(ReceiveRetryCount + 1) on Windows Server 2003 and Windows XP.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="ec1c0-161">No se realiza ningún reintento para un mensaje que se entrega correctamente.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-161">No retries are made for a message that is delivered successfully.</span></span>  
  
 <span data-ttu-id="ec1c0-162">Para realizar un seguimiento del número de veces que se intenta leer un mensaje, Windows Vista mantiene una propiedad de mensaje durable que cuenta el número de anulaciones y una propiedad de recuento de movimiento que cuenta el número de veces que el mensaje se mueve entre la cola de la aplicación y las subcolas.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-162">To keep track of the number of times a message read is attempted, Windows Vista maintains a durable message property that counts the number of aborts and a move count property that counts the number of times the message moves between the application queue and subqueues.</span></span> <span data-ttu-id="ec1c0-163">El canal de WCF los usa para calcular el número de reintentos de recepción y el número de ciclos de reintento.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-163">The WCF channel uses these to compute the receive retry count and the retry cycles count.</span></span> <span data-ttu-id="ec1c0-164">En Windows Server 2003 y Windows XP, el número de anulaciones se mantiene en la memoria por el canal de WCF y se restablece si se produce un error en la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-164">On Windows Server 2003 and Windows XP, the abort count is maintained in memory by the WCF channel and is reset if the application fails.</span></span> <span data-ttu-id="ec1c0-165">Además, el canal de WCF puede mantener los recuentos de anulación de hasta 256 mensajes en memoria en cualquier momento.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-165">Also, the WCF channel can hold the abort counts for up to 256 messages in memory at any time.</span></span> <span data-ttu-id="ec1c0-166">Si se lee el mensaje número 257, se restablece el recuento de la anulación del mensaje más antiguo.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-166">If a 257th message is read, then the oldest message's abort count is reset.</span></span>  
  
 <span data-ttu-id="ec1c0-167">Las propiedades de recuento de la anulación y recuento de movimiento están disponibles para la operación del servicio a través del contexto de la operación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-167">The abort count and move count properties are available to the service operation through the operation context.</span></span> <span data-ttu-id="ec1c0-168">En el ejemplo de código siguiente se muestra cómo obtener acceso.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-168">The following code example shows how to access them.</span></span>  
  
 [!code-csharp[S_UE_MSMQ_Poison#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/service.cs#1)]  
  
 <span data-ttu-id="ec1c0-169">WCF proporciona dos enlaces en cola estándar:</span><span class="sxs-lookup"><span data-stu-id="ec1c0-169">WCF provides two standard queued bindings:</span></span>  
  
- <span data-ttu-id="ec1c0-170"><xref:System.ServiceModel.NetMsmqBinding>.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-170"><xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="ec1c0-171">Un enlace de .NET Framework adecuado para realizar la comunicación basada en cola con otros extremos de WCF.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-171">A .NET Framework binding suitable for performing queue-based communication with other WCF endpoints.</span></span>  
  
- <span data-ttu-id="ec1c0-172"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-172"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span></span> <span data-ttu-id="ec1c0-173">Un enlace conveniente para comunicar con aplicaciones Message Queuing existentes.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-173">A binding suitable for communicating with existing Message Queuing applications.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="ec1c0-174">Puede modificar las propiedades de estos enlaces en función de los requisitos de su servicio WCF.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-174">You can alter properties in these bindings based on the requirements of your WCF service.</span></span> <span data-ttu-id="ec1c0-175">Todo el mecanismo de control de mensajes dudosos es local a la aplicación receptora.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-175">The entire poison message handling mechanism is local to the receiving application.</span></span> <span data-ttu-id="ec1c0-176">El proceso es invisible para la aplicación emisora a menos que la aplicación receptora se detenga finalmente y devuelva una confirmación de que no se pudo realizar la acción al remitente.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-176">The process is invisible to the sending application unless the receiving application ultimately stops and sends a negative acknowledgment back to the sender.</span></span> <span data-ttu-id="ec1c0-177">En ese caso, el mensaje se mueve a la cola de mensajes no enviados del remitente.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-177">In that case, the message is moved to the sender's dead-letter queue.</span></span>  
  
## <a name="best-practice-handling-msmqpoisonmessageexception"></a><span data-ttu-id="ec1c0-178">Procedimiento recomendado: Controlar MsmqPoisonMessageException</span><span class="sxs-lookup"><span data-stu-id="ec1c0-178">Best Practice: Handling MsmqPoisonMessageException</span></span>  

 <span data-ttu-id="ec1c0-179">Cuando el servicio determina que un mensaje es dudoso, el transporte en cola arroja <xref:System.ServiceModel.MsmqPoisonMessageException> que contiene `LookupId` del mensaje dudoso.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-179">When the service determines that a message is poison, the queued transport throws a <xref:System.ServiceModel.MsmqPoisonMessageException> that contains the `LookupId` of the poison message.</span></span>  
  
 <span data-ttu-id="ec1c0-180">Una aplicación receptora puede implementar la interfaz <xref:System.ServiceModel.Dispatcher.IErrorHandler> para controlar cualquier error que la aplicación requiera.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-180">A receiving application can implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface to handle any errors that the application requires.</span></span> <span data-ttu-id="ec1c0-181">Para obtener más información, vea [extender el control sobre el control de errores y los informes](../samples/extending-control-over-error-handling-and-reporting.md).</span><span class="sxs-lookup"><span data-stu-id="ec1c0-181">For more information, see [Extending Control Over Error Handling and Reporting](../samples/extending-control-over-error-handling-and-reporting.md).</span></span>  
  
 <span data-ttu-id="ec1c0-182">La aplicación puede requerir algún tipo de control automatizado de mensajes dudosos que los aparte a una cola específica de manera que el servicio pueda tener acceso al resto de los mensajes de la cola.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-182">The application may require some kind of automated handling of poison messages that moves the poison messages to a poison message queue so that the service can access the rest of the messages in the queue.</span></span> <span data-ttu-id="ec1c0-183">El único escenario para utilizar el mecanismo del controlador de errores para realizar escuchas para las excepciones de mensajes dudosos es cuando <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> está establecido en <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-183">The only scenario for using the error-handler mechanism to listen for poison-message exceptions is when the <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> setting is set to <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span></span> <span data-ttu-id="ec1c0-184">El ejemplo de mensaje dudoso para Message Queuing 3.0 demuestra este comportamiento.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-184">The poison-message sample for Message Queuing 3.0 demonstrates this behavior.</span></span> <span data-ttu-id="ec1c0-185">A continuación se dibujan los pasos a realizar para controlar los mensajes dudosos, incluyendo los procedimientos recomendados:</span><span class="sxs-lookup"><span data-stu-id="ec1c0-185">The following outlines the steps to take to handle poison messages, including best practices:</span></span>  
  
1. <span data-ttu-id="ec1c0-186">Asegúrese de que la configuración de mensajes dudosos refleja los requisitos de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-186">Ensure your poison settings reflect the requirements of your application.</span></span> <span data-ttu-id="ec1c0-187">Al trabajar con la configuración, asegúrese de que comprende las diferencias entre las capacidades de Message Queue Server en Windows Vista, Windows Server 2003 y Windows XP.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-187">When working with the settings, ensure that you understand the differences between the capabilities of Message Queuing on Windows Vista, Windows Server 2003, and Windows XP.</span></span>  
  
2. <span data-ttu-id="ec1c0-188">Si es necesario, implemente `IErrorHandler` para controlar los errores de mensajes dudosos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-188">If necessary, implement the `IErrorHandler` to handle poison-message errors.</span></span> <span data-ttu-id="ec1c0-189">Dado que al establecer `ReceiveErrorHandling` en `Fault` se requiere un mecanismo manual para quitar el mensaje dudoso de la cola o corregir un problema derivado externo, lo normal es implementar `IErrorHandler` cuando `ReceiveErrorHandling` se establece en `Fault`, como se muestra en el código siguiente.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-189">Because setting `ReceiveErrorHandling` to `Fault` requires a manual mechanism to move the poison message out of the queue or to correct an external dependent issue, the typical usage is to implement `IErrorHandler` when `ReceiveErrorHandling` is set to `Fault`, as shown in the following code.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonerrorhandler.cs#2)]  
  
3. <span data-ttu-id="ec1c0-190">Cree un `PoisonBehaviorAttribute` que pueda usar el comportamiento del servicio.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-190">Create a `PoisonBehaviorAttribute` that the service behavior can use.</span></span> <span data-ttu-id="ec1c0-191">El comportamiento instala `IErrorHandler` en el distribuidor.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-191">The behavior installs the `IErrorHandler` on the dispatcher.</span></span> <span data-ttu-id="ec1c0-192">Vea el ejemplo de código siguiente.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-192">See the following code example.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonbehaviorattribute.cs#3)]  
  
4. <span data-ttu-id="ec1c0-193">Asegúrese de que su servicio se anote con el atributo de comportamiento de mensajes venenosos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-193">Ensure that your service is annotated with the poison behavior attribute.</span></span>  

 <span data-ttu-id="ec1c0-194">Además, si `ReceiveErrorHandling` se establece en `Fault`, `ServiceHost` genera un error al encontrar el mensaje dudoso.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-194">In addition, if the `ReceiveErrorHandling` is set to `Fault`, the `ServiceHost` faults when encountering the poison message.</span></span> <span data-ttu-id="ec1c0-195">Puede enlazarlo con el evento que ha generado el error y cerrar el servicio, tomar medidas correctivas y reiniciarlo.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-195">You can hook up to the faulted event and shut down the service, take corrective actions, and restart.</span></span> <span data-ttu-id="ec1c0-196">Por ejemplo, puede tomar nota del `LookupId` de la <xref:System.ServiceModel.MsmqPoisonMessageException> propagada a `IErrorHandler` y, cuando el host de servicio genere el error, puede utilizar la API `System.Messaging` para recibir el mensaje de la cola, utilizando el `LookupId` para quitarlo de la cola y almacenarlo en algún almacén externo u otra cola.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-196">For example, the `LookupId` in the <xref:System.ServiceModel.MsmqPoisonMessageException> propagated to the `IErrorHandler` can be noted and when the service host faults, you could use the `System.Messaging` API to receive the message from the queue using the `LookupId` to remove the message from the queue and store the message in some external store or another queue.</span></span> <span data-ttu-id="ec1c0-197">Puede reiniciar a continuación `ServiceHost` para reanudar el procesamiento normal.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-197">You can then restart `ServiceHost` to resume normal processing.</span></span> <span data-ttu-id="ec1c0-198">El [control de mensajes dudosos en MSMQ 4,0](../samples/poison-message-handling-in-msmq-4-0.md) muestra este comportamiento.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-198">The [Poison Message Handling in MSMQ 4.0](../samples/poison-message-handling-in-msmq-4-0.md) demonstrates this behavior.</span></span>  
  
## <a name="transaction-time-out-and-poison-messages"></a><span data-ttu-id="ec1c0-199">Tiempo de espera de la transacción y mensajes dudosos</span><span class="sxs-lookup"><span data-stu-id="ec1c0-199">Transaction Time-Out and Poison Messages</span></span>  

 <span data-ttu-id="ec1c0-200">Una clase de errores se puede producir entre el canal de transporte en cola y el código de usuario.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-200">A class of errors can occur between the queued transport channel and the user code.</span></span> <span data-ttu-id="ec1c0-201">Estos errores pueden ser detectados por niveles intermedios, como el nivel de seguridad de mensajes o el servicio que distribuye la lógica.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-201">These errors can be detected by layers in-between, such as the message security layer or the service dispatching logic.</span></span> <span data-ttu-id="ec1c0-202">Por ejemplo, cuando se detecta la ausencia de un certificado X.509 en el nivel de seguridad SOAP y la ausencia de una acción son casos en los que el mensaje no se distribuye a la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-202">For example, a missing X.509 certificate detected in the SOAP security layer and a missing action are cases where the message does get dispatched to the application.</span></span> <span data-ttu-id="ec1c0-203">Cuando esto sucede, el modelo de servicio quita el mensaje.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-203">When this happens, the service model drops the message.</span></span> <span data-ttu-id="ec1c0-204">Puesto que el mensaje se lee en una transacción y no se puede proporcionar un resultado para la misma, la transacción agota el tiempo de espera, se anula y el mensaje se pone de nuevo en la cola.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-204">Because the message is read in a transaction and an outcome for that transaction cannot be provided, the transaction eventually times out, aborts, and the message is put back into the queue.</span></span> <span data-ttu-id="ec1c0-205">En otras palabras, para una clase determinada de errores, la transacción no se anula inmediatamente pero espera hasta que se agote el tiempo de espera de la transacción. Puede modificar el tiempo de espera de la transacción para un servicio mediante <xref:System.ServiceModel.ServiceBehaviorAttribute> .</span><span class="sxs-lookup"><span data-stu-id="ec1c0-205">In other words, for a certain class of errors, the transaction does not immediately abort but waits until the transaction times out. You can modify the transaction time-out for a service using <xref:System.ServiceModel.ServiceBehaviorAttribute>.</span></span>  
  
 <span data-ttu-id="ec1c0-206">Para cambiar el tiempo de espera de la transacción en función de todo el equipo, modifique el archivo machine.config y establezca el tiempo de espera de la transacción adecuado. Es importante tener en cuenta que, en función del tiempo de espera establecido en la transacción, la transacción finalmente se anula y vuelve a la cola y se incrementa su recuento de anulaciones.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-206">To change the transaction time-out on a computer-wide basis, modify the machine.config file and set the appropriate transaction time-out. It is important to note that, depending on the time-out set in the transaction, the transaction eventually aborts and goes back to the queue and its abort count is incremented.</span></span> <span data-ttu-id="ec1c0-207">Finalmente, el mensaje se convierte en dudoso y se elimina de la forma que especifique la configuración del usuario.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-207">Eventually, the message becomes poison and the right disposition is made according to the user settings.</span></span>  
  
## <a name="sessions-and-poison-messages"></a><span data-ttu-id="ec1c0-208">Sesiones y mensajes dudosos</span><span class="sxs-lookup"><span data-stu-id="ec1c0-208">Sessions and Poison Messages</span></span>  

 <span data-ttu-id="ec1c0-209">Una sesión sufre los mismos procedimientos de reintento y control de mensajes dudosos como un mensaje único.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-209">A session undergoes the same retry and poison-message handling procedures as a single message.</span></span> <span data-ttu-id="ec1c0-210">Las propiedades enumeradas anteriormente para los mensajes dudosos se aplican a toda la sesión.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-210">The properties previously listed for poison messages apply to the entire session.</span></span> <span data-ttu-id="ec1c0-211">Esto significa que se reintenta la sesión completa y se envía a una cola de mensajes dudosos final o a la cola de mensajes no enviados del remitente si se rechaza el mensaje.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-211">This means that the entire session is retried and goes to a final poison-message queue or the sender’s dead-letter queue if the message is rejected.</span></span>  
  
## <a name="batching-and-poison-messages"></a><span data-ttu-id="ec1c0-212">Procesamiento por lotes y mensajes dudosos</span><span class="sxs-lookup"><span data-stu-id="ec1c0-212">Batching and Poison Messages</span></span>  

 <span data-ttu-id="ec1c0-213">Si un mensaje se vuelve un mensaje dudoso y es parte de un lote, se deshace el lote completo y el canal vuelve a leer un mensaje cada vez.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-213">If a message becomes a poison message and is part of a batch, then the entire batch is rolled back and the channel returns to reading one message at a time.</span></span> <span data-ttu-id="ec1c0-214">Para obtener más información sobre el procesamiento por lotes, consulte [mensajes por lotes en una transacción](batching-messages-in-a-transaction.md) .</span><span class="sxs-lookup"><span data-stu-id="ec1c0-214">For more information about batching, see [Batching Messages in a Transaction](batching-messages-in-a-transaction.md)</span></span>  
  
## <a name="poison-message-handling-for-messages-in-a-poison-queue"></a><span data-ttu-id="ec1c0-215">Control de mensajes dudosos para mensajes en una cola de mensajes dudosos</span><span class="sxs-lookup"><span data-stu-id="ec1c0-215">Poison-message Handling for Messages in a Poison Queue</span></span>  

 <span data-ttu-id="ec1c0-216">El control de mensajes dudosos no finaliza cuando un mensaje se coloca en la cola de mensajes dudosos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-216">Poison-message handling does not end when a message is placed in the poison-message queue.</span></span> <span data-ttu-id="ec1c0-217">Los mensajes de la cola de mensajes dudosos también se deben leer y controlar.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-217">Messages in the poison-message queue must still be read and handled.</span></span> <span data-ttu-id="ec1c0-218">Puede utilizar un subconjunto de los valores de control de mensajes dudosos al leer mensajes de la subcola final de mensajes dudosos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-218">You can use a subset of the poison-message handling settings when reading messages from the final poison subqueue.</span></span> <span data-ttu-id="ec1c0-219">La configuración aplicable es `ReceiveRetryCount` y `ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-219">The applicable settings are `ReceiveRetryCount` and `ReceiveErrorHandling`.</span></span> <span data-ttu-id="ec1c0-220">Puede establecer `ReceiveErrorHandling` en Drop, Reject o Fault.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-220">You can set `ReceiveErrorHandling` to Drop, Reject, or Fault.</span></span> <span data-ttu-id="ec1c0-221">Se omite `MaxRetryCycles` y se produce una excepción si `ReceiveErrorHandling` se establece en Move.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-221">`MaxRetryCycles` is ignored and an exception is thrown if `ReceiveErrorHandling` is set to Move.</span></span>  
  
## <a name="windows-vista-windows-server-2003-and-windows-xp-differences"></a><span data-ttu-id="ec1c0-222">Diferencias entre Windows Vista, Windows Server 2003, y Windows XP</span><span class="sxs-lookup"><span data-stu-id="ec1c0-222">Windows Vista, Windows Server 2003, and Windows XP Differences</span></span>  

 <span data-ttu-id="ec1c0-223">Como se indicó anteriormente, no todas las configuraciones de control de mensajes dudosos se aplican a Windows Server 2003 y Windows XP.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-223">As noted earlier, not all poison-message handling settings apply to Windows Server 2003 and Windows XP.</span></span> <span data-ttu-id="ec1c0-224">Las siguientes diferencias principales entre Message Queue Server en Windows Server 2003, Windows XP y Windows Vista son relevantes para el control de mensajes dudosos:</span><span class="sxs-lookup"><span data-stu-id="ec1c0-224">The following key differences between Message Queuing on Windows Server 2003, Windows XP, and Windows Vista are relevant to poison-message handling:</span></span>  
  
- <span data-ttu-id="ec1c0-225">Message Queue Server en Windows Vista admite subcolas, mientras que Windows Server 2003 y Windows XP no admiten subcolas.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-225">Message Queuing in Windows Vista supports subqueues, while Windows Server 2003 and Windows XP do not support subqueues.</span></span> <span data-ttu-id="ec1c0-226">Las subcolas se utilizan en el control de mensajes dudosos.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-226">Subqueues are used in poison-message handling.</span></span> <span data-ttu-id="ec1c0-227">Las colas de reintento y la cola dudosa son subcolas en la cola de la aplicación que se crea dependiendo de los valores de control del mensaje dudoso.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-227">The retry queues and the poison queue are subqueues to the application queue that is created based on the poison-message handling settings.</span></span> <span data-ttu-id="ec1c0-228">`MaxRetryCycles` dicta cuántas subcolas de reintento se crean.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-228">The `MaxRetryCycles` dictates how many retry subqueues to create.</span></span> <span data-ttu-id="ec1c0-229">Por lo tanto, cuando se ejecuta en Windows Server 2003 o Windows XP, `MaxRetryCycles` se omiten y `ReceiveErrorHandling.Move` no se permiten.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-229">Therefore, when running on Windows Server 2003 or Windows XP, `MaxRetryCycles` are ignored and `ReceiveErrorHandling.Move` is not allowed.</span></span>  
  
- <span data-ttu-id="ec1c0-230">Message Queue Server en Windows Vista admite la confirmación negativa, mientras que Windows Server 2003 y Windows XP no lo hacen.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-230">Message Queuing in Windows Vista supports negative acknowledgment, while Windows Server 2003 and Windows XP do not.</span></span> <span data-ttu-id="ec1c0-231">Una confirmación de que no se pudo realizar la acción del administrador de la cola receptora hace que el administrador de la cola emisora coloque el mensaje rechazado en la cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-231">A negative acknowledgment from the receiving queue manager causes the sending queue manager to place the rejected message in the dead-letter queue.</span></span> <span data-ttu-id="ec1c0-232">Como tal, `ReceiveErrorHandling.Reject` no se permite con Windows Server 2003 y Windows XP.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-232">As such, `ReceiveErrorHandling.Reject` is not allowed with Windows Server 2003 and Windows XP.</span></span>  
  
- <span data-ttu-id="ec1c0-233">Message Queue Server en Windows Vista admite una propiedad de mensaje que mantiene el recuento del número de veces que se intenta la entrega del mensaje.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-233">Message Queuing in Windows Vista supports a message property that keeps count of the number of times message delivery is attempted.</span></span> <span data-ttu-id="ec1c0-234">Esta propiedad de recuento de anulación no está disponible en Windows Server 2003 y Windows XP.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-234">This abort count property is not available on Windows Server 2003 and Windows XP.</span></span> <span data-ttu-id="ec1c0-235">WCF mantiene el recuento de anulación en memoria, por lo que es posible que esta propiedad no contenga un valor preciso cuando el mismo mensaje es leído por más de un servicio WCF en una granja.</span><span class="sxs-lookup"><span data-stu-id="ec1c0-235">WCF maintains the abort count in memory, so it is possible that this property may not contain an accurate value when the same message is read by more than one WCF service in a farm.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="ec1c0-236">Vea también</span><span class="sxs-lookup"><span data-stu-id="ec1c0-236">See also</span></span>

- [<span data-ttu-id="ec1c0-237">Información general de colas</span><span class="sxs-lookup"><span data-stu-id="ec1c0-237">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="ec1c0-238">Diferencias en las características de cola en Windows Vista, Windows Server 2003 y Windows XP</span><span class="sxs-lookup"><span data-stu-id="ec1c0-238">Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP</span></span>](diff-in-queue-in-vista-server-2003-windows-xp.md)
- [<span data-ttu-id="ec1c0-239">Especificación y administración de errores en contratos y servicios</span><span class="sxs-lookup"><span data-stu-id="ec1c0-239">Specifying and Handling Faults in Contracts and Services</span></span>](../specifying-and-handling-faults-in-contracts-and-services.md)
