---
title: Procedimiento para crear un token personalizado
description: Obtenga información sobre cómo crear un token de seguridad personalizado en WCF mediante la clase SecurityToken y cómo integrarlo con un proveedor de tokens de seguridad y un autenticador.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- SecurityTokenParameters class
- security [WCF], creating custom tokens
- WSSecurityTokenSerializer class
- SecurityToken class
ms.assetid: 6d892973-1558-4115-a9e1-696777776125
ms.openlocfilehash: e0d80fe2433d894ef1f9e110e9090701dc305d8e
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/26/2020
ms.locfileid: "96266758"
---
# <a name="how-to-create-a-custom-token"></a><span data-ttu-id="5cc79-103">Procedimiento para crear un token personalizado</span><span class="sxs-lookup"><span data-stu-id="5cc79-103">How to: Create a Custom Token</span></span>

<span data-ttu-id="5cc79-104">Este tema muestra cómo crear un token de seguridad personalizado mediante la clase <xref:System.IdentityModel.Tokens.SecurityToken> y cómo integrarlo en un autenticador y en un proveedor de token de seguridad personalizado.</span><span class="sxs-lookup"><span data-stu-id="5cc79-104">This topic shows how to create a custom security token using the <xref:System.IdentityModel.Tokens.SecurityToken> class, and how to integrate it with a custom security token provider and authenticator.</span></span> <span data-ttu-id="5cc79-105">Para obtener un ejemplo de código completo, vea el ejemplo de [token personalizado](../samples/custom-token.md) .</span><span class="sxs-lookup"><span data-stu-id="5cc79-105">For a complete code example see the [Custom Token](../samples/custom-token.md) sample.</span></span>  
  
 <span data-ttu-id="5cc79-106">Un *token de seguridad* es esencialmente un elemento XML que utiliza el marco de seguridad Windows Communication Foundation (WCF) para representar las notificaciones sobre un remitente dentro del mensaje SOAP.</span><span class="sxs-lookup"><span data-stu-id="5cc79-106">A *security token* is essentially an XML element that is used by the Windows Communication Foundation (WCF) security framework to represent claims about a sender inside the SOAP message.</span></span> <span data-ttu-id="5cc79-107">La seguridad de WCF proporciona varios tokens para los modos de autenticación proporcionados por el sistema.</span><span class="sxs-lookup"><span data-stu-id="5cc79-107">WCF security provides various tokens for system-provided authentication modes.</span></span> <span data-ttu-id="5cc79-108">En los ejemplos se incluye un token de seguridad de certificado X.509 representado por la clase <xref:System.IdentityModel.Tokens.X509SecurityToken> o un token de seguridad Username representado por la clase <xref:System.IdentityModel.Tokens.UserNameSecurityToken>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-108">Examples include an X.509 certificate security token represented by the <xref:System.IdentityModel.Tokens.X509SecurityToken> class or a Username security token represented by the <xref:System.IdentityModel.Tokens.UserNameSecurityToken> class.</span></span>  
  
 <span data-ttu-id="5cc79-109">A veces los tipos proporcionados no admiten un modo de autenticación o credencial.</span><span class="sxs-lookup"><span data-stu-id="5cc79-109">Sometimes an authentication mode or credential is not supported by the provided types.</span></span> <span data-ttu-id="5cc79-110">En ese caso, es necesario para crear un token de seguridad personalizado para proporcionar una representación XML de la credencial personalizada dentro del mensaje SOAP.</span><span class="sxs-lookup"><span data-stu-id="5cc79-110">In that case, it is necessary to create a custom security token to provide an XML representation of the custom credential inside the SOAP message.</span></span>  
  
 <span data-ttu-id="5cc79-111">En los procedimientos siguientes se muestra cómo crear un token de seguridad personalizado y cómo integrarlo con la infraestructura de seguridad de WCF.</span><span class="sxs-lookup"><span data-stu-id="5cc79-111">The following procedures show how to create a custom security token and how to integrate it with the WCF security infrastructure.</span></span> <span data-ttu-id="5cc79-112">En este tema se crea un token de tarjeta de crédito que se utiliza para pasar información sobre la tarjeta de crédito del cliente al servidor.</span><span class="sxs-lookup"><span data-stu-id="5cc79-112">This topic creates a credit card token that is used to pass information about the client's credit card to the server.</span></span>  
  
 <span data-ttu-id="5cc79-113">Para obtener más información sobre las credenciales personalizadas y el administrador de tokens de seguridad, vea [Tutorial: crear credenciales de cliente y servicio personalizadas](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="5cc79-113">For more information about custom credentials and security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
 <span data-ttu-id="5cc79-114">Vea el espacio de nombres <xref:System.IdentityModel.Tokens> para obtener más clases que representen tokens de seguridad.</span><span class="sxs-lookup"><span data-stu-id="5cc79-114">See the <xref:System.IdentityModel.Tokens> namespace for more classes that represent security tokens.</span></span>  
  
## <a name="procedures"></a><span data-ttu-id="5cc79-115">Procedimientos</span><span class="sxs-lookup"><span data-stu-id="5cc79-115">Procedures</span></span>  

 <span data-ttu-id="5cc79-116">Es necesario proporcionar a una aplicación cliente una manera de especificar información de la tarjeta de crédito para la infraestructura de seguridad.</span><span class="sxs-lookup"><span data-stu-id="5cc79-116">A client application must be provided with a way to specify credit card information for the security infrastructure.</span></span> <span data-ttu-id="5cc79-117">Una clase de credenciales de cliente personalizada pone esta información a disposición de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="5cc79-117">This information is made available to the application by a custom client credentials class.</span></span> <span data-ttu-id="5cc79-118">El primer paso es crear una clase para que represente la información de la tarjeta de crédito para las credenciales de cliente personalizadas.</span><span class="sxs-lookup"><span data-stu-id="5cc79-118">The first step is to create a class to represent the credit card information for custom client credentials.</span></span>  
  
#### <a name="to-create-a-class-that-represents-credit-card-information-inside-client-credentials"></a><span data-ttu-id="5cc79-119">Para crear una clase que represente información de la tarjeta de crédito dentro de las credenciales de cliente</span><span class="sxs-lookup"><span data-stu-id="5cc79-119">To create a class that represents credit card information inside client credentials</span></span>  
  
1. <span data-ttu-id="5cc79-120">Defina una nueva clase que represente la información de la tarjeta de crédito para la aplicación.</span><span class="sxs-lookup"><span data-stu-id="5cc79-120">Define a new class that represents the credit card information for the application.</span></span> <span data-ttu-id="5cc79-121">En el siguiente ejemplo se nombra la clase `CreditCardInfo`.</span><span class="sxs-lookup"><span data-stu-id="5cc79-121">The following example names the class `CreditCardInfo`.</span></span>  
  
2. <span data-ttu-id="5cc79-122">Agregue las propiedades adecuadas a la clase para permitir que una aplicación establezca la información necesaria para el token personalizado.</span><span class="sxs-lookup"><span data-stu-id="5cc79-122">Add appropriate properties to the class to allow an application set the necessary information required for the custom token.</span></span> <span data-ttu-id="5cc79-123">En este ejemplo, la clase tiene tres propiedades: `CardNumber`, `CardIssuer`y `ExpirationDate`.</span><span class="sxs-lookup"><span data-stu-id="5cc79-123">In this example, the class has three properties: `CardNumber`, `CardIssuer`, and `ExpirationDate`.</span></span>  
  
     [!code-csharp[c_CustomToken#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#4)]
     [!code-vb[c_CustomToken#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#4)]  
  
 <span data-ttu-id="5cc79-124">A continuación, se ha de crear una clase que represente el token de seguridad personalizado.</span><span class="sxs-lookup"><span data-stu-id="5cc79-124">Next, a class that represents the custom security token must be created.</span></span> <span data-ttu-id="5cc79-125">Esta clase la usan las clases de proveedor de tokens de seguridad, autenticador y serializador para pasar información sobre el token de seguridad hacia y desde la infraestructura de seguridad de WCF.</span><span class="sxs-lookup"><span data-stu-id="5cc79-125">This class is used by the security token provider, authenticator, and serializer classes to pass information about the security token to and from the WCF security infrastructure.</span></span>  
  
#### <a name="to-create-a-custom-security-token-class"></a><span data-ttu-id="5cc79-126">Para crear una clase de token de seguridad personalizada</span><span class="sxs-lookup"><span data-stu-id="5cc79-126">To create a custom security token class</span></span>  
  
1. <span data-ttu-id="5cc79-127">Defina una clase nueva derivada de la clase <xref:System.IdentityModel.Tokens.SecurityToken>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-127">Define a new class derived from the <xref:System.IdentityModel.Tokens.SecurityToken> class.</span></span> <span data-ttu-id="5cc79-128">En este ejemplo se crea una clase denominada `CreditCardToken`.</span><span class="sxs-lookup"><span data-stu-id="5cc79-128">This example creates a class named `CreditCardToken`.</span></span>  
  
2. <span data-ttu-id="5cc79-129">Invalide la propiedad <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-129">Override the <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> property.</span></span> <span data-ttu-id="5cc79-130">Esta propiedad se utiliza para obtener el identificador local del token de seguridad que se utiliza para señalar a la representación XML del token de seguridad desde otros elementos dentro del mensaje SOAP.</span><span class="sxs-lookup"><span data-stu-id="5cc79-130">This property is used to get the local identifier of the security token that is used to point to the security token XML representation from other elements inside the SOAP message.</span></span> <span data-ttu-id="5cc79-131">En este ejemplo, se le puede pasar un identificador de token como parámetro de constructor o se puede generar uno nuevo aleatorio cada vez que se cree una instancia de token de seguridad.</span><span class="sxs-lookup"><span data-stu-id="5cc79-131">In this example, a token identifier can be either passed to it as a constructor parameter or a new random one is generated every time a security token instance is created.</span></span>  
  
3. <span data-ttu-id="5cc79-132">Implemente la propiedad <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-132">Implement the <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> property.</span></span> <span data-ttu-id="5cc79-133">Esta propiedad devuelve una colección de claves de seguridad que representa la instancia del token de seguridad.</span><span class="sxs-lookup"><span data-stu-id="5cc79-133">This property returns a collection of security keys that the security token instance represents.</span></span> <span data-ttu-id="5cc79-134">WCF puede usar estas claves para firmar o cifrar partes del mensaje SOAP.</span><span class="sxs-lookup"><span data-stu-id="5cc79-134">Such keys can be used by WCF to sign or encrypt parts of the SOAP message.</span></span> <span data-ttu-id="5cc79-135">En este ejemplo, el token de seguridad de la tarjeta de crédito no puede contener ninguna clave de seguridad; por consiguiente, la implementación siempre devuelve una colección vacía.</span><span class="sxs-lookup"><span data-stu-id="5cc79-135">In this example, the credit card security token cannot contain any security keys; therefore, the implementation always returns an empty collection.</span></span>  
  
4. <span data-ttu-id="5cc79-136">Invalide las propiedades <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> y <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-136">Override the <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> and <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> properties.</span></span> <span data-ttu-id="5cc79-137">WCF usa estas propiedades para determinar la validez de la instancia del token de seguridad.</span><span class="sxs-lookup"><span data-stu-id="5cc79-137">These properties are used by WCF to determine the validity of the security token instance.</span></span> <span data-ttu-id="5cc79-138">En este ejemplo, el token de seguridad de la tarjeta de crédito solo tiene una fecha de expiración, por lo que la propiedad `ValidFrom` devuelve <xref:System.DateTime> que representa la fecha y hora de creación de la instancia.</span><span class="sxs-lookup"><span data-stu-id="5cc79-138">In this example, the credit card security token has only an expiration date, so the `ValidFrom` property returns a <xref:System.DateTime> that represents the date and time of the instance creation.</span></span>  
  
     [!code-csharp[c_CustomToken#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#1)]
     [!code-vb[c_CustomToken#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#1)]  
  
 <span data-ttu-id="5cc79-139">Cuando se crea un nuevo tipo de token de seguridad, requiere una implementación de la clase <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-139">When a new security token type is created, it requires an implementation of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span> <span data-ttu-id="5cc79-140">La implementación se utiliza en la configuración del elemento de enlace de seguridad para representar el nuevo tipo de token.</span><span class="sxs-lookup"><span data-stu-id="5cc79-140">The implementation is used in the security binding element configuration to represent the new token type.</span></span> <span data-ttu-id="5cc79-141">La clase de los parámetros de token de seguridad sirve como plantilla que se emplea para igualar a la instancia del token de seguridad real cuando se procesa un mensaje.</span><span class="sxs-lookup"><span data-stu-id="5cc79-141">The security token parameters class serves as a template that is used to match the actual security token instance to when a message is processed.</span></span> <span data-ttu-id="5cc79-142">La plantilla proporciona propiedades adicionales que una aplicación puede utilizar para especificar los criterios a los que debe ajustarse el token de seguridad para que pueda usarse o autenticarse.</span><span class="sxs-lookup"><span data-stu-id="5cc79-142">The template provides additional properties that an application can use to specify criteria that the security token must match to be used or authenticated.</span></span> <span data-ttu-id="5cc79-143">En el ejemplo siguiente no se agregan propiedades adicionales, por lo que solo se compara el tipo de token de seguridad cuando la infraestructura de WCF busca una instancia de token de seguridad para usar o validar.</span><span class="sxs-lookup"><span data-stu-id="5cc79-143">The following example does not add any additional properties, so only the security token type is matched when the WCF infrastructure searches for a security token instance to use or to validate.</span></span>  
  
#### <a name="to-create-a-custom-security-token-parameters-class"></a><span data-ttu-id="5cc79-144">Para crear una clase de parámetros de token de seguridad personalizada</span><span class="sxs-lookup"><span data-stu-id="5cc79-144">To create a custom security token parameters class</span></span>  
  
1. <span data-ttu-id="5cc79-145">Defina una clase nueva derivada de la clase <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-145">Define a new class derived from the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span>  
  
2. <span data-ttu-id="5cc79-146">Implemente el método <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-146">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> method.</span></span> <span data-ttu-id="5cc79-147">Copie todos los campos internos definidos en su clase, si hubiese alguno.</span><span class="sxs-lookup"><span data-stu-id="5cc79-147">Copy all internal fields defined in your class, if any.</span></span> <span data-ttu-id="5cc79-148">Este ejemplo no define ningún campo adicional.</span><span class="sxs-lookup"><span data-stu-id="5cc79-148">This example does not define any additional fields.</span></span>  
  
3. <span data-ttu-id="5cc79-149">Implemente la propiedad de solo lectura <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-149">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> read-only property.</span></span> <span data-ttu-id="5cc79-150">Esta propiedad devuelve `true` si el tipo de token de seguridad representado por esta clase se puede utilizar para autenticar un cliente a un servicio.</span><span class="sxs-lookup"><span data-stu-id="5cc79-150">This property returns `true` if the security token type represented by this class can be used to authenticate a client to a service.</span></span> <span data-ttu-id="5cc79-151">En este ejemplo, el token de seguridad de la tarjeta de crédito se puede utilizar para autenticar un cliente a un servicio.</span><span class="sxs-lookup"><span data-stu-id="5cc79-151">In this example, the credit card security token can be used to authenticate a client to a service.</span></span>  
  
4. <span data-ttu-id="5cc79-152">Implemente la propiedad de solo lectura <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-152">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> read-only property.</span></span> <span data-ttu-id="5cc79-153">Esta propiedad devuelve `true` si el tipo de token de seguridad representado por esta clase se puede utilizar para autenticar un servicio a un cliente.</span><span class="sxs-lookup"><span data-stu-id="5cc79-153">This property returns `true` if the security token type represented by this class can be used to authenticate a service to a client.</span></span> <span data-ttu-id="5cc79-154">En este ejemplo, el token de seguridad de la tarjeta de crédito no se puede utilizar para autenticar un servicio a un cliente.</span><span class="sxs-lookup"><span data-stu-id="5cc79-154">In this example, the credit card security token cannot be used to authenticate a service to a client.</span></span>  
  
5. <span data-ttu-id="5cc79-155">Implemente la propiedad de solo lectura <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-155">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> read-only property.</span></span> <span data-ttu-id="5cc79-156">Esta propiedad devuelve `true` si el tipo de token de seguridad representado por esta clase puede asignarse a una cuenta de Windows.</span><span class="sxs-lookup"><span data-stu-id="5cc79-156">This property returns `true` if the security token type represented by this class can be mapped to a Windows account.</span></span> <span data-ttu-id="5cc79-157">En ese caso, el resultado de la autenticación se representa mediante una instancia de la clase <xref:System.Security.Principal.WindowsIdentity>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-157">If so, the authentication result is represented by a <xref:System.Security.Principal.WindowsIdentity> class instance.</span></span> <span data-ttu-id="5cc79-158">En este ejemplo, el token no se puede asignar a una cuenta de Windows.</span><span class="sxs-lookup"><span data-stu-id="5cc79-158">In this example, the token cannot be mapped to a Windows account.</span></span>  
  
6. <span data-ttu-id="5cc79-159">Implemente el método <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-159">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> method.</span></span> <span data-ttu-id="5cc79-160">El marco de seguridad de WCF llama a este método cuando requiere una referencia a la instancia del token de seguridad representada por esta clase de parámetros de token de seguridad.</span><span class="sxs-lookup"><span data-stu-id="5cc79-160">This method is called by WCF security framework when it requires a reference to the security token instance represented by this security token parameters class.</span></span> <span data-ttu-id="5cc79-161">Tanto la instancia del token de seguridad real como el <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> que especifica el tipo de la referencia que se solicita se pasan a este método como argumentos.</span><span class="sxs-lookup"><span data-stu-id="5cc79-161">Both the actual security token instance and <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> that specifies the type of the reference that is being requested are passed to this method as arguments.</span></span> <span data-ttu-id="5cc79-162">En este ejemplo el token de seguridad de la tarjeta de crédito solo admite referencias internas.</span><span class="sxs-lookup"><span data-stu-id="5cc79-162">In this example, only internal references are supported by the credit card security token.</span></span> <span data-ttu-id="5cc79-163">La clase <xref:System.IdentityModel.Tokens.SecurityToken> tiene funcionalidad para crear referencias internas, por lo que la implementación no precisa código adicional.</span><span class="sxs-lookup"><span data-stu-id="5cc79-163">The <xref:System.IdentityModel.Tokens.SecurityToken> class has functionality to create internal references; therefore, the implementation does not require additional code.</span></span>  
  
7. <span data-ttu-id="5cc79-164">Implemente el método <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-164">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method.</span></span> <span data-ttu-id="5cc79-165">WCF llama a este método para convertir la instancia de la clase de parámetros de token de seguridad en una instancia de la <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> clase.</span><span class="sxs-lookup"><span data-stu-id="5cc79-165">This method is called by WCF to convert the security token parameters class instance into an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> class.</span></span> <span data-ttu-id="5cc79-166">Los proveedores de tokens de seguridad utilizan el resultado para crear la instancia del token de seguridad adecuada.</span><span class="sxs-lookup"><span data-stu-id="5cc79-166">The result is used by security token providers to create the appropriate security token instance.</span></span>  
  
     [!code-csharp[c_CustomToken#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#2)]
     [!code-vb[c_CustomToken#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#2)]  
  
 <span data-ttu-id="5cc79-167">Los tokens de seguridad se transmiten dentro de los mensajes SOAP, lo que necesita un mecanismo de traducción entre la representación del token de seguridad en memoria y la representación en tránsito.</span><span class="sxs-lookup"><span data-stu-id="5cc79-167">Security tokens are transmitted inside SOAP messages, which requires a translation mechanism between the in-memory security token representation and the on-the-wire representation.</span></span> <span data-ttu-id="5cc79-168">WCF usa un serializador de tokens de seguridad para realizar esta tarea.</span><span class="sxs-lookup"><span data-stu-id="5cc79-168">WCF uses a security token serializer to accomplish this task.</span></span> <span data-ttu-id="5cc79-169">Todos los tokens personalizados deben estar acompañados de un serializador de tokens de seguridad personalizado que pueda serializar y deserializar el token de seguridad personalizado del mensaje SOAP.</span><span class="sxs-lookup"><span data-stu-id="5cc79-169">Every custom token must be accompanied by a custom security token serializer that can serialize and deserialize the custom security token from the SOAP message.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5cc79-170">Las claves derivadas están habilitadas de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="5cc79-170">Derived keys are enabled by default.</span></span> <span data-ttu-id="5cc79-171">Si crea un token de seguridad personalizado y lo usa como el token principal, WCF deriva una clave a partir de él.</span><span class="sxs-lookup"><span data-stu-id="5cc79-171">If you create a custom security token and use it as the primary token, WCF derives a key from it.</span></span> <span data-ttu-id="5cc79-172">En este proceso, llama al serializador del token de seguridad personalizado para escribir la <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> para el token de seguridad personalizado durante la serialización de `DerivedKeyToken` en la conexión.</span><span class="sxs-lookup"><span data-stu-id="5cc79-172">While doing so, it calls the custom security token serializer to write the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> for the custom security token while serializing the `DerivedKeyToken` to the wire.</span></span> <span data-ttu-id="5cc79-173">En el extremo receptor, al deserializar el token fuera de la conexión, el serializador `DerivedKeyToken` espera un elemento `SecurityTokenReference` como elemento secundario de nivel superior bajo sí mismo.</span><span class="sxs-lookup"><span data-stu-id="5cc79-173">On the receiving end, when deserializing the token off the wire, the `DerivedKeyToken` serializer expects a `SecurityTokenReference` element as the top-level child under itself.</span></span> <span data-ttu-id="5cc79-174">Si el serializador del token de seguridad personalizado no agregó un elemento `SecurityTokenReference` durante la serialización de su tipo de cláusula, se produce una excepción.</span><span class="sxs-lookup"><span data-stu-id="5cc79-174">If the custom security token serializer did not add a `SecurityTokenReference` element while serializing its clause type, an exception is thrown.</span></span>  
  
#### <a name="to-create-a-custom-security-token-serializer"></a><span data-ttu-id="5cc79-175">Para crear un serializador de tokens de seguridad personalizado</span><span class="sxs-lookup"><span data-stu-id="5cc79-175">To create a custom security token serializer</span></span>  
  
1. <span data-ttu-id="5cc79-176">Defina una clase nueva derivada de la clase <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-176">Define a new class derived from the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> class.</span></span>  
  
2. <span data-ttu-id="5cc79-177">Invalide el método <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29>, que se basa en un <xref:System.Xml.XmlReader> para leer la secuencia XML.</span><span class="sxs-lookup"><span data-stu-id="5cc79-177">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> method, which relies on an <xref:System.Xml.XmlReader> to read the XML stream.</span></span> <span data-ttu-id="5cc79-178">El método devuelve `true` si la implementación del serializador puede deserializar el token de seguridad dado su elemento actual.</span><span class="sxs-lookup"><span data-stu-id="5cc79-178">The method returns `true` if the serializer implementation can deserialize the security token based given its current element.</span></span> <span data-ttu-id="5cc79-179">En este ejemplo, este método comprueba si el elemento XML actual del lector XML tiene el nombre de elemento y espacio de nombres correctos.</span><span class="sxs-lookup"><span data-stu-id="5cc79-179">In this example, this method checks whether the XML reader's current XML element has the correct element name and namespace.</span></span> <span data-ttu-id="5cc79-180">Si no es así, llama a la implementación de la clase base de este método para controlar el elemento XML.</span><span class="sxs-lookup"><span data-stu-id="5cc79-180">If it does not, it calls the base class implementation of this method to handle the XML element.</span></span>  
  
3. <span data-ttu-id="5cc79-181">Invalide el método <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-181">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> method.</span></span> <span data-ttu-id="5cc79-182">Este método lee el contenido XML del token de seguridad y construye la representación en memoria adecuada para el mismo.</span><span class="sxs-lookup"><span data-stu-id="5cc79-182">This method reads the XML content of the security token and constructs the appropriate in-memory representation for it.</span></span> <span data-ttu-id="5cc79-183">Si no reconoce el elemento XML sobre el que se alza el lector XML pasado, llama a la implementación de la clase base para procesar los tipos de token proporcionados por el sistema.</span><span class="sxs-lookup"><span data-stu-id="5cc79-183">If it does not recognize the XML element on which the passed-in XML reader is standing, it calls the base class implementation to process the system-provided token types.</span></span>  
  
4. <span data-ttu-id="5cc79-184">Invalide el método <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-184">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="5cc79-185">Este método devuelve `true` si puede convertir la representación del token en memoria (pasado como argumento) en la representación XML.</span><span class="sxs-lookup"><span data-stu-id="5cc79-185">This method returns `true` if it can convert the in-memory token representation (passed in as an argument) to the XML representation.</span></span> <span data-ttu-id="5cc79-186">Si no puede convertirlo, llama a la implementación de la clase base.</span><span class="sxs-lookup"><span data-stu-id="5cc79-186">If it cannot convert, it calls the base class implementation.</span></span>  
  
5. <span data-ttu-id="5cc79-187">Invalide el método <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-187">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="5cc79-188">Este método convierte una representación de tokens de seguridad en memoria en una representación XML.</span><span class="sxs-lookup"><span data-stu-id="5cc79-188">This method converts an in-memory security token representation into an XML representation.</span></span> <span data-ttu-id="5cc79-189">Si el método no puede convertirlo, llama a la implementación de la clase base.</span><span class="sxs-lookup"><span data-stu-id="5cc79-189">If the method cannot convert, it calls the base class implementation.</span></span>  
  
     [!code-csharp[c_CustomToken#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#3)]
     [!code-vb[c_CustomToken#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#3)]  
  
 <span data-ttu-id="5cc79-190">Después de completar los cuatro procedimientos anteriores, integre el token de seguridad personalizado con el proveedor de tokens de seguridad, autenticador, administrador y credenciales de cliente y servicio.</span><span class="sxs-lookup"><span data-stu-id="5cc79-190">After completing the four previous procedures, integrate the custom security token with the security token provider, authenticator, manager, and client and service credentials.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-provider"></a><span data-ttu-id="5cc79-191">Para integrar el token de seguridad personalizado con un proveedor de tokens de seguridad</span><span class="sxs-lookup"><span data-stu-id="5cc79-191">To integrate the custom security token with a security token provider</span></span>  
  
1. <span data-ttu-id="5cc79-192">El proveedor de tokens de seguridad crea, modifica (si es necesario) y devuelve una instancia del token.</span><span class="sxs-lookup"><span data-stu-id="5cc79-192">The security token provider creates, modifies (if necessary), and returns an instance of the token.</span></span> <span data-ttu-id="5cc79-193">Para crear un proveedor personalizado para el token de seguridad personalizado, cree una clase que herede de la clase <xref:System.IdentityModel.Selectors.SecurityTokenProvider>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-193">To create a custom provider for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class.</span></span> <span data-ttu-id="5cc79-194">En el ejemplo siguiente se invalida el método <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> para devolver una instancia de `CreditCardToken`.</span><span class="sxs-lookup"><span data-stu-id="5cc79-194">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> method to return an instance of the `CreditCardToken`.</span></span> <span data-ttu-id="5cc79-195">Para obtener más información acerca de los proveedores de tokens de seguridad personalizados, consulte [Cómo: crear un proveedor de tokens de seguridad personalizado](how-to-create-a-custom-security-token-provider.md).</span><span class="sxs-lookup"><span data-stu-id="5cc79-195">For more information about custom security token providers, see [How to: Create a Custom Security Token Provider](how-to-create-a-custom-security-token-provider.md).</span></span>  
  
     [!code-csharp[c_CustomToken#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#6)]
     [!code-vb[c_CustomToken#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#6)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-authenticator"></a><span data-ttu-id="5cc79-196">Para integrar el token de seguridad personalizado con un autenticador de tokens de seguridad</span><span class="sxs-lookup"><span data-stu-id="5cc79-196">To integrate the custom security token with a security token authenticator</span></span>  
  
1. <span data-ttu-id="5cc79-197">El autenticador de tokens de seguridad valida el contenido del token de seguridad cuando se extrae del mensaje.</span><span class="sxs-lookup"><span data-stu-id="5cc79-197">The security token authenticator validates the content of the security token when it is extracted from the message.</span></span> <span data-ttu-id="5cc79-198">Para crear un autenticador personalizado para el token de seguridad personalizado, cree una clase que herede de la clase <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-198">To create a custom authenticator for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span> <span data-ttu-id="5cc79-199">En el siguiente ejemplo se reemplaza el método <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-199">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="5cc79-200">Para obtener más información sobre los autenticadores de tokens de seguridad personalizados, consulte [Cómo: crear un autenticador de tokens de seguridad personalizado](how-to-create-a-custom-security-token-authenticator.md).</span><span class="sxs-lookup"><span data-stu-id="5cc79-200">For more information about custom security token authenticators, see [How to: Create a Custom Security Token Authenticator](how-to-create-a-custom-security-token-authenticator.md).</span></span>  
  
     [!code-csharp[c_CustomToken#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#7)]
     [!code-vb[c_CustomToken#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#7)]  
  
     [!code-csharp[c_CustomToken#12](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#12)]
     [!code-vb[c_CustomToken#12](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#12)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-manager"></a><span data-ttu-id="5cc79-201">Para integrar el token de seguridad personalizado con un administrador de tokens de seguridad</span><span class="sxs-lookup"><span data-stu-id="5cc79-201">To integrate the custom security token with a security token manager</span></span>  
  
1. <span data-ttu-id="5cc79-202">El administrador de tokens de seguridad crea el proveedor de tokens, el autenticador de seguridad y las instancias del serializador de tokens adecuados.</span><span class="sxs-lookup"><span data-stu-id="5cc79-202">The security token manager creates the appropriate token provider, security authenticator, and token serializer instances.</span></span> <span data-ttu-id="5cc79-203">Para crear un administrador de tokens personalizado, cree una clase que herede de la clase <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-203">To create a custom token manager, create a class that inherits from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="5cc79-204">Los métodos principales de la clase usan un <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> para crear el proveedor y las credenciales de cliente o servicio adecuados.</span><span class="sxs-lookup"><span data-stu-id="5cc79-204">The primary methods of the class use a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> to create the appropriate provider and client or service credentials.</span></span> <span data-ttu-id="5cc79-205">Para obtener más información acerca de los administradores de tokens de seguridad personalizados, vea [Tutorial: crear credenciales de cliente y servicio personalizadas](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="5cc79-205">For more information about custom security token managers, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#8)]
     [!code-vb[c_CustomToken#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#8)]  
  
     [!code-csharp[c_CustomToken#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#9)]
     [!code-vb[c_CustomToken#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#9)]  
  
#### <a name="to-integrate-the-custom-security-token-with-custom-client-and-service-credentials"></a><span data-ttu-id="5cc79-206">Para integrar el token de seguridad personalizado con credenciales de cliente y servicio personalizadas</span><span class="sxs-lookup"><span data-stu-id="5cc79-206">To integrate the custom security token with custom client and service credentials</span></span>  
  
1. <span data-ttu-id="5cc79-207">Es necesario agregar credenciales de cliente y servicio personalizadas para proporcionar una API de manera que la aplicación permita especificar la información de tokens personalizados que utiliza la infraestructura de tokens de seguridad personalizados antes creada para proporcionar y autenticar el contenido del token de seguridad personalizado.</span><span class="sxs-lookup"><span data-stu-id="5cc79-207">The custom client and service credentials must be added to provide an API for the application to allow specifying custom token information that is used by the custom security token infrastructure created previously to provide and authenticate the custom security token content.</span></span> <span data-ttu-id="5cc79-208">Los ejemplos siguientes muestran cómo hacerlo.</span><span class="sxs-lookup"><span data-stu-id="5cc79-208">The following samples show how this can be done.</span></span> <span data-ttu-id="5cc79-209">Para obtener más información acerca de las credenciales de cliente y servicio personalizadas, vea [Tutorial: crear credenciales de cliente y servicio personalizadas](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="5cc79-209">For more information about custom client and service credentials, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#10](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#10)]
     [!code-vb[c_CustomToken#10](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#10)]  
  
     [!code-csharp[c_customToken#11](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#11)]
     [!code-vb[c_customToken#11](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#11)]  
  
 <span data-ttu-id="5cc79-210">La clase de parámetros de token de seguridad personalizada creada anteriormente se utiliza para indicar al marco de seguridad de WCF que se debe usar un token de seguridad personalizado al comunicarse con un servicio.</span><span class="sxs-lookup"><span data-stu-id="5cc79-210">The custom security token parameters class created previously is used to tell the WCF security framework that a custom security token must be used when communicating with a service.</span></span> <span data-ttu-id="5cc79-211">En el siguiente procedimiento se muestra cómo hacerlo:</span><span class="sxs-lookup"><span data-stu-id="5cc79-211">The following procedure shows how this can be done.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-the-binding"></a><span data-ttu-id="5cc79-212">Para integrar el token de seguridad personalizado con el enlace</span><span class="sxs-lookup"><span data-stu-id="5cc79-212">To integrate the custom security token with the binding</span></span>  
  
1. <span data-ttu-id="5cc79-213">La clase de parámetros de tokens de seguridad personalizados ha de especificarse en una de las colecciones de parámetros de tokens que se exponen en la clase <xref:System.ServiceModel.Channels.SecurityBindingElement>.</span><span class="sxs-lookup"><span data-stu-id="5cc79-213">The custom security token parameters class must be specified in one of the token parameters collections that are exposed on the <xref:System.ServiceModel.Channels.SecurityBindingElement> class.</span></span> <span data-ttu-id="5cc79-214">El siguiente ejemplo usa la colección devuelta por `SignedEncrypted`.</span><span class="sxs-lookup"><span data-stu-id="5cc79-214">The following example uses the collection returned by `SignedEncrypted`.</span></span> <span data-ttu-id="5cc79-215">El código agrega el token personalizado de la tarjeta de crédito a cada mensaje enviado desde el cliente al servicio con su contenido firmado y cifrado automáticamente.</span><span class="sxs-lookup"><span data-stu-id="5cc79-215">The code adds the credit card custom token to every message sent from the client to the service with its content automatically signed and encrypted.</span></span>  
  
     [!code-csharp[c_CustomToken#13](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#13)]
     [!code-vb[c_CustomToken#13](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#13)]  
  
 <span data-ttu-id="5cc79-216">En este tema se muestran los distintos elementos de código necesarios para implementar y usar un token personalizado.</span><span class="sxs-lookup"><span data-stu-id="5cc79-216">This topic shows the various pieces of code necessary to implement and use a custom token.</span></span> <span data-ttu-id="5cc79-217">Para ver un ejemplo completo de cómo encajan todos estos fragmentos de código, vea [token personalizado](../samples/custom-token.md).</span><span class="sxs-lookup"><span data-stu-id="5cc79-217">To see a complete example of how all these pieces of code fit together see, [Custom Token](../samples/custom-token.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="5cc79-218">Vea también</span><span class="sxs-lookup"><span data-stu-id="5cc79-218">See also</span></span>

- <xref:System.IdentityModel.Tokens.SecurityToken>
- <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>
- <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>
- <xref:System.IdentityModel.Selectors.SecurityTokenProvider>
- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>
- <xref:System.IdentityModel.Policy.IAuthorizationPolicy>
- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>
- <xref:System.IdentityModel.Selectors.SecurityTokenManager>
- <xref:System.ServiceModel.Description.ClientCredentials>
- <xref:System.ServiceModel.Description.ServiceCredentials>
- <xref:System.ServiceModel.Channels.SecurityBindingElement>
- [<span data-ttu-id="5cc79-219">Tutorial: Crear credenciales de cliente y servicio personalizadas</span><span class="sxs-lookup"><span data-stu-id="5cc79-219">Walkthrough: Creating Custom Client and Service Credentials</span></span>](walkthrough-creating-custom-client-and-service-credentials.md)
- [<span data-ttu-id="5cc79-220">Procedimiento para crear un autenticador de tokens de seguridad personalizado</span><span class="sxs-lookup"><span data-stu-id="5cc79-220">How to: Create a Custom Security Token Authenticator</span></span>](how-to-create-a-custom-security-token-authenticator.md)
- [<span data-ttu-id="5cc79-221">Procedimiento para crear un proveedor de tokens de seguridad personalizado</span><span class="sxs-lookup"><span data-stu-id="5cc79-221">How to: Create a Custom Security Token Provider</span></span>](how-to-create-a-custom-security-token-provider.md)
