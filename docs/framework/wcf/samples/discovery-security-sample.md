---
title: Ejemplo de seguridad de la detección
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: 0957e8ddaee99e60b205c92319dc2c61e2ab007a
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/26/2020
ms.locfileid: "96292641"
---
# <a name="discovery-security-sample"></a><span data-ttu-id="ff8a9-102">Ejemplo de seguridad de la detección</span><span class="sxs-lookup"><span data-stu-id="ff8a9-102">Discovery Security Sample</span></span>

<span data-ttu-id="ff8a9-103">La especificación de la detección no requiere que los puntos de conexión que participan en el proceso de detección sean seguros.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="ff8a9-104">Al mejorar los mensajes de detección gracias a la seguridad, se mitigan varios tipos de ataques (alteración del mensaje, denegación de servicio, repetición y suplantación).</span><span class="sxs-lookup"><span data-stu-id="ff8a9-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="ff8a9-105">Este ejemplo implementa canales personalizados que calculan y comprueban las firmas de mensaje utilizando el formato de firma compacto (descrito en la sección 8.2 de la especificación de detección WS).</span><span class="sxs-lookup"><span data-stu-id="ff8a9-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="ff8a9-106">El ejemplo admite la [especificación de detección 2005](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) y la [versión 1,1](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span><span class="sxs-lookup"><span data-stu-id="ff8a9-106">The sample supports both the [2005 Discovery specification](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) and the [1.1 version](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span></span>  
  
 <span data-ttu-id="ff8a9-107">El canal personalizado se aplica encima de la pila del canal existente para los puntos de conexión de anuncio y detección.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="ff8a9-108">De esta manera, se aplica un encabezado de firma para cada mensaje enviado.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="ff8a9-109">La firma se comprueba en los mensajes recibidos, y cuando no coincide o cuando los mensajes no tienen una firma, los mensajes se quitan.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="ff8a9-110">Para firmar y comprobar los mensajes, el ejemplo utiliza los certificados.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="ff8a9-111">Discusión</span><span class="sxs-lookup"><span data-stu-id="ff8a9-111">Discussion</span></span>  

 <span data-ttu-id="ff8a9-112">WCF es extensible y permite a los usuarios personalizar los canales según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-112">WCF is extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="ff8a9-113">En el ejemplo se implementa un elemento de enlace seguro de detección que crea canales seguros.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="ff8a9-114">Los canales seguros aplican y comprueban las firmas de los mensajes, y se aplican encima de la pila actual.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="ff8a9-115">El elemento de enlace seguro crea generadores de canales seguros y agentes de escucha del canal.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="ff8a9-116">Generador de canales seguro</span><span class="sxs-lookup"><span data-stu-id="ff8a9-116">Secure Channel Factory</span></span>  

 <span data-ttu-id="ff8a9-117">El generador de canales seguro crea canales dúplex o de salida que agregan una firma compacta a los encabezados de mensaje.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="ff8a9-118">Para mantener el tamaño de los mensajes lo más pequeño posible, se utiliza el formato de firma compacta.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="ff8a9-119">La estructura de una firma compacta se muestra en el siguiente ejemplo.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >
  [<d:Sig Scheme="xs:anyURI"
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"
          Sig="xs:base64Binary"
          ... />]?  
  ...
</d:Security>  
```  
  
> [!NOTE]
> <span data-ttu-id="ff8a9-120">`PrefixList` se agregó en el protocolo de la versión de detección de 2008.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="ff8a9-121">Para calcular la firma, el ejemplo determina los elementos de firma expandidos.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="ff8a9-122">Se crea una firma XML (`SignedInfo`), utilizando el prefijo del espacio de nombres `ds`, tal y como requiere la especificación de la detección WS.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="ff8a9-123">En la firma se hace referencia al cuerpo y a todos los encabezados en los espacios de nombres de direccionamiento y detección, de modo que no se puedan alterar.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="ff8a9-124">Cada elemento al que se hace referencia se transforma utilizando la canonización exclusiva ( <http://www.w3.org/2001/10/xml-exc-c14n#> ) y, a continuación, se calcula un valor de síntesis de SHA-1 ( <http://www.w3.org/2000/09/xmldsig#sha1> ).</span><span class="sxs-lookup"><span data-stu-id="ff8a9-124">Each referenced element is transformed using the Exclusive Canonicalization (<http://www.w3.org/2001/10/xml-exc-c14n#>), and then an SHA-1 digest value is computed (<http://www.w3.org/2000/09/xmldsig#sha1>).</span></span> <span data-ttu-id="ff8a9-125">En función de todos los elementos a los que se hace referencia y sus valores de síntesis, el valor de firma se calcula utilizando el algoritmo RSA ( <http://www.w3.org/2000/09/xmldsig#rsa-sha1> ).</span><span class="sxs-lookup"><span data-stu-id="ff8a9-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (<http://www.w3.org/2000/09/xmldsig#rsa-sha1>).</span></span>  
  
 <span data-ttu-id="ff8a9-126">Los mensajes se firman con un certificado especificado por el cliente.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="ff8a9-127">La ubicación del almacén, el nombre y el nombre del sujeto del certificado deben especificarse al crear el elemento de enlace.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-127">The store location, name, and certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="ff8a9-128">El `KeyId` de la firma compacta representa el identificador de clave del token de firma y es el identificador de clave de asunto (SKI) del token de firma o (si el SKI no existe) un valor hash SHA-1 de la clave pública del token de firma.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="ff8a9-129">Agente de escucha del canal seguro</span><span class="sxs-lookup"><span data-stu-id="ff8a9-129">Secure Channel Listener</span></span>  

 <span data-ttu-id="ff8a9-130">El agente de escucha del canal seguro crea canales dúplex o de entrada que comprueban la firma compacta en los mensajes recibidos.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="ff8a9-131">Para comprobar la firma, el `KeyId` especificado en la firma compacta adjuntada al mensaje se utiliza para seleccionar un certificado del almacén especificado.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="ff8a9-132">Si el mensaje no tiene ninguna firma o su comprobación no es correcta, los mensajes se quitan.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="ff8a9-133">Para utilizar el enlace seguro, el ejemplo define un generador que crea objetos <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> y <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> personalizados con el elemento de enlace seguro de detección agregado.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="ff8a9-134">Estos extremos seguros se pueden utilizar en agentes de escucha de anuncio de detección y en los servicios que pueden detectarse.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="ff8a9-135">Detalles del ejemplo</span><span class="sxs-lookup"><span data-stu-id="ff8a9-135">Sample Details</span></span>  

 <span data-ttu-id="ff8a9-136">En el ejemplo se incluyen una biblioteca y cuatro aplicaciones de consola:</span><span class="sxs-lookup"><span data-stu-id="ff8a9-136">The sample includes a library and 4 console applications:</span></span>
  
- <span data-ttu-id="ff8a9-137">**DiscoverySecurityChannels**: biblioteca que expone el enlace seguro.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="ff8a9-138">La biblioteca calcula y comprueba la firma compacta para los mensajes entrantes o salientes.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
- <span data-ttu-id="ff8a9-139">**Servicio**: servicio que expone el contrato de ICalculatorService, autohospedado.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="ff8a9-140">El servicio se marca como detectable.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="ff8a9-141">El usuario especifica los detalles del certificado utilizados para firmar los mensajes especificando la ubicación del almacén y nombre, y el nombre de asunto u otro identificador único para el certificado, y el almacén donde se encuentran los certificados de cliente (que se usan para comprobar la firma de los mensajes entrantes).</span><span class="sxs-lookup"><span data-stu-id="ff8a9-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="ff8a9-142">Según estos detalles, se compila y se usa un UdpDiscoveryEndpoint.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
- <span data-ttu-id="ff8a9-143">**Client**: esta clase intenta detectar un ICalculatorService y llamar a métodos en el servicio.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="ff8a9-144">De nuevo, se crea un <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> con seguridad agregada y se usa para firmar y comprobar los mensajes.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
- <span data-ttu-id="ff8a9-145">**AnnouncementListener**: servicio autohospedado que realiza escuchas de anuncios en línea y sin conexión, y utiliza el extremo de anuncio seguro.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="ff8a9-146">Si Setup.bat se ejecuta varias veces, el administrador de certificados le solicita que elija un certificado que agregar, ya que hay certificados duplicados.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="ff8a9-147">En ese caso, Setup.bat se debería anular y se debería llamar a Cleanup.bat, porque los duplicados ya se han creado.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="ff8a9-148">Cleanup.bat también le solicita que elija un certificado que eliminar.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="ff8a9-149">Seleccione un certificado en la lista y siga ejecutando Cleanup.bat hasta que no quede ningún certificado.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="ff8a9-150">Para utilizar este ejemplo</span><span class="sxs-lookup"><span data-stu-id="ff8a9-150">To use this sample</span></span>  
  
1. <span data-ttu-id="ff8a9-151">Ejecute el script de Setup.bat desde un Símbolo del sistema para desarrolladores para Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-151">Execute the Setup.bat script from a Developer Command Prompt for Visual Studio.</span></span> <span data-ttu-id="ff8a9-152">El ejemplo usa los certificados para firmar y comprobar los mensajes.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="ff8a9-153">El script crea los certificados mediante Makecert.exe y, a continuación, los instala utilizando Certmgr.exe.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="ff8a9-154">El script se debe ejecutar con privilegios de administrador.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-154">The script must be run with administrator privileges.</span></span>  
  
2. <span data-ttu-id="ff8a9-155">Para compilar y ejecutar el ejemplo, abra el archivo Security. sln en Visual Studio y elija **volver a generar todo**.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="ff8a9-156">Actualizar las propiedades de la solución para iniciar varios proyectos: seleccione **iniciar** para todos los proyectos excepto DiscoverySecureChannels.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="ff8a9-157">Ejecute la solución normalmente.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-157">Run the solution normally.</span></span>  
  
3. <span data-ttu-id="ff8a9-158">Una vez haya terminado con el ejemplo, ejecute el script Cleanup.bat que quita los certificados creados para este ejemplo.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="ff8a9-159">Puede que los ejemplos ya estén instalados en su equipo.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="ff8a9-160">Compruebe el siguiente directorio (predeterminado) antes de continuar.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-160">Check for the following (default) directory before continuing.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples`  
>
> <span data-ttu-id="ff8a9-161">Si este directorio no existe, vaya a [ejemplos de Windows Communication Foundation (WCF) y Windows Workflow Foundation (WF) para .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) para descargar todos los Windows Communication Foundation (WCF) y [!INCLUDE[wf1](../../../../includes/wf1-md.md)] ejemplos.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="ff8a9-162">Este ejemplo se encuentra en el siguiente directorio.</span><span class="sxs-lookup"><span data-stu-id="ff8a9-162">This sample is located in the following directory.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
