---
title: Procedimiento para consultar instancias no guardadas
ms.date: 03/30/2017
ms.assetid: 294019b1-c1a7-4b81-a14f-b47c106cd723
ms.openlocfilehash: 54a442dab6700dda33cf05df1fb5c60a96bcbd56
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/26/2020
ms.locfileid: "96280005"
---
# <a name="how-to-query-for-non-persisted-instances"></a><span data-ttu-id="c63ee-102">Procedimiento para consultar instancias no guardadas</span><span class="sxs-lookup"><span data-stu-id="c63ee-102">How to: Query for Non-persisted Instances</span></span>

<span data-ttu-id="c63ee-103">Cuando se crea una nueva instancia de un servicio y este tiene el comportamiento del almacén de instancias de flujo de trabajo de SQL definido, el host del servicio crea una entrada inicial para esa instancia en el almacén de instancias.</span><span class="sxs-lookup"><span data-stu-id="c63ee-103">When a new instance of a service is created and the service has the SQL Workflow Instance Store behavior defined, the service host creates a initial entry for that service instance in the instance store.</span></span> <span data-ttu-id="c63ee-104">Como consecuencia, cuando la instancia de servicio se guarda por primera vez, el comportamiento del almacén de instancias de flujo de trabajo de SQL almacena el estado de la instancia actual junto con los datos adicionales que se requieren para la activación, recuperación y control.</span><span class="sxs-lookup"><span data-stu-id="c63ee-104">Subsequently when the service instance persists for the first time, the SQL Workflow Instance Store behavior stores the current instance state together with additional data that is required for activation, recovery, and control.</span></span>

<span data-ttu-id="c63ee-105">Si una instancia no se guarda después de crear la entrada inicial para la instancia, se dice que la instancia de servicio está en el estado no conservado.</span><span class="sxs-lookup"><span data-stu-id="c63ee-105">If an instance is not persisted after the initial entry for the instance is created, the service instance is said to be in the non-persisted state.</span></span> <span data-ttu-id="c63ee-106">Todas las instancias de servicio conservadas pueden consultar y controlar.</span><span class="sxs-lookup"><span data-stu-id="c63ee-106">All the persisted service instances can be queried and controlled.</span></span> <span data-ttu-id="c63ee-107">Las instancias de servicio no conservadas no se pueden consultar ni controlar.</span><span class="sxs-lookup"><span data-stu-id="c63ee-107">Non-persisted service instances can neither be queried nor controlled.</span></span> <span data-ttu-id="c63ee-108">Si una instancia no conservada se suspende debido a una excepción no controlada, se puede consultar pero no controlar.</span><span class="sxs-lookup"><span data-stu-id="c63ee-108">If a non-persisted instance is suspended due to an unhandled exception it can be queried but not controlled.</span></span>

<span data-ttu-id="c63ee-109">Las instancias de servicio duraderas que todavía no se han guardado permanecen en un estado no conservado en los siguientes casos:</span><span class="sxs-lookup"><span data-stu-id="c63ee-109">Durable service instances that are not yet persisted remain in a non-persisted state in the following scenarios:</span></span>

- <span data-ttu-id="c63ee-110">El host del servicio se bloquea antes de que la instancia se guarde por primera vez.</span><span class="sxs-lookup"><span data-stu-id="c63ee-110">The service host crashes before the instance persisted for the first time.</span></span> <span data-ttu-id="c63ee-111">La entrada inicial para la instancia permanece en el almacén de instancias.</span><span class="sxs-lookup"><span data-stu-id="c63ee-111">The initial entry for the instance remains in the instance store.</span></span> <span data-ttu-id="c63ee-112">La instancia no se puede recuperar.</span><span class="sxs-lookup"><span data-stu-id="c63ee-112">The instance is not recoverable.</span></span> <span data-ttu-id="c63ee-113">Si lleva un mensaje correlacionado, la instancia pasa a estar de nuevo activa.</span><span class="sxs-lookup"><span data-stu-id="c63ee-113">If a correlated message arrives, the instance becomes active again.</span></span>

- <span data-ttu-id="c63ee-114">La instancia experimenta una excepción no controlada antes de ser guardada por primera vez.</span><span class="sxs-lookup"><span data-stu-id="c63ee-114">The instance experiences an unhandled exception before it persisted for the first time.</span></span> <span data-ttu-id="c63ee-115">Se producen los siguientes escenarios:</span><span class="sxs-lookup"><span data-stu-id="c63ee-115">The following scenarios arise</span></span>

  - <span data-ttu-id="c63ee-116">Si el valor de la propiedad **UnhandledExceptionAction** se establece en **Abandon**, la información de implementación del servicio se escribe en el almacén de instancias y la instancia se descarga de la memoria.</span><span class="sxs-lookup"><span data-stu-id="c63ee-116">If the value of the **UnhandledExceptionAction** property is set to **Abandon**, the service deployment information is written to the instance store and the instance is unloaded from memory.</span></span> <span data-ttu-id="c63ee-117">La instancia permanece en un estado no conservado en la base de datos de persistencia.</span><span class="sxs-lookup"><span data-stu-id="c63ee-117">The instance remains in non-persisted state in the persistence database.</span></span>

  - <span data-ttu-id="c63ee-118">Si el valor de la propiedad **UnhandledExceptionAction** se establece en **AbandonAndSuspend**, la información de implementación del servicio se escribe en la base de datos de persistencia y el estado de la instancia se establece en **Suspended**.</span><span class="sxs-lookup"><span data-stu-id="c63ee-118">If the value of the **UnhandledExceptionAction** property is set to **AbandonAndSuspend**, the service deployment information is written to the persistence database and the instance state is set to **Suspended**.</span></span> <span data-ttu-id="c63ee-119">La instancia no se puede reanudar, cancelar ni finalizar.</span><span class="sxs-lookup"><span data-stu-id="c63ee-119">The instance cannot be resumed, canceled, or terminated.</span></span> <span data-ttu-id="c63ee-120">El host del servicio no puede cargar la instancia porque esta todavía no se ha guardado y, por lo tanto, la entrada de base de datos para la instancia no está completa.</span><span class="sxs-lookup"><span data-stu-id="c63ee-120">The service host cannot load the instance because the instance hasn't persisted yet and, hence the database entry for the instance is not complete.</span></span>

  - <span data-ttu-id="c63ee-121">Si el valor de la propiedad **UnhandledExceptionAction** está establecido en **Cancelar** o **Finalizar**, la información de implementación del servicio se escribe en el almacén de instancias y el estado de la instancia se establece en **completado**.</span><span class="sxs-lookup"><span data-stu-id="c63ee-121">If the value of the **UnhandledExceptionAction** property is set to **Cancel** or **Terminate**, the service deployment information is written to the instance store and the instance state is set to **Completed**.</span></span>

<span data-ttu-id="c63ee-122">En las siguientes secciones se proporcionan consultas de ejemplo para localizar instancias no conservadas en la base de datos de persistencia de SQL y para eliminar estas instancias de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="c63ee-122">The following sections provide sample queries to find non-persisted instances in the SQL persistence database and to delete these instances from the database.</span></span>

## <a name="to-find-all-instances-not-persisted-yet"></a><span data-ttu-id="c63ee-123">Para localizar todas las instancias que todavía no se han guardado</span><span class="sxs-lookup"><span data-stu-id="c63ee-123">To find all instances not persisted yet</span></span>

<span data-ttu-id="c63ee-124">La siguiente consulta SQL devuelve el identificador y la hora de creación de todas las instancias que todavía no se han guardado en la base de datos de persistencia.</span><span class="sxs-lookup"><span data-stu-id="c63ee-124">The following SQL query returns the ID and creation time for all instances that are not persisted in to the persistence database yet.</span></span>

```sql
select InstanceId, CreationTime from [System.Activities.DurableInstancing].[Instances] where IsInitialized = 0;
```

## <a name="to-find-all-instances-not-persisted-yet-and-also-not-loaded"></a><span data-ttu-id="c63ee-125">Para localizar todas las instancias que todavía y no se han guardado ni cargado</span><span class="sxs-lookup"><span data-stu-id="c63ee-125">To find all instances not persisted yet and also not loaded</span></span>

 <span data-ttu-id="c63ee-126">La siguiente consulta SQL devuelve el identificador y la hora de creación de todas las instancias que no se han guardado ni tampoco cargado.</span><span class="sxs-lookup"><span data-stu-id="c63ee-126">The following SQL query returns ID and creation time for all instances that are not persisted and also are not loaded.</span></span>

```sql
select InstanceId, CreationTime from [System.Activities.DurableInstancing].[Instances] where IsInitialized = 0 and CurrentMachine is NULL;
```

## <a name="to-find-all-suspended-instances-not-persisted-yet"></a><span data-ttu-id="c63ee-127">Para localizar todas las instancias suspendidas que todavía no se han guardado</span><span class="sxs-lookup"><span data-stu-id="c63ee-127">To find all suspended instances not persisted yet</span></span>

<span data-ttu-id="c63ee-128">La siguiente consulta SQL devuelve el identificador, la hora de creación, el motivo de la suspensión y el nombre de excepción de la suspensión de todas las instancias que no se han guardado y están en estado suspendido.</span><span class="sxs-lookup"><span data-stu-id="c63ee-128">The following SQL query returns ID, creation time, suspension reason, and suspension exception name for all instances that are not persisted and also in a suspended state.</span></span>

```sql
select InstanceId, CreationTime, SuspensionReason, SuspensionExceptionName from [System.Activities.DurableInstancing].[Instances] where IsInitialized = 0 and IsSuspended = 1;
```

## <a name="to-delete-non-persisted-instances-from-the-persistence-database"></a><span data-ttu-id="c63ee-129">Para eliminar las instancias no conservadas de la base de datos de persistencia</span><span class="sxs-lookup"><span data-stu-id="c63ee-129">To delete non-persisted instances from the persistence database</span></span>

<span data-ttu-id="c63ee-130">Debe comprobar periódicamente en el almacén de instancias la existencia de instancias no conservadas y quitarlas si está seguro de que la instancia no recibirá ningún mensaje correlacionado.</span><span class="sxs-lookup"><span data-stu-id="c63ee-130">You should periodically check the instance store for non-persisted instances and remove instances from the instance store if you are sure that the instance will not receive a correlated message.</span></span> <span data-ttu-id="c63ee-131">Por ejemplo, si la instancia ha estado en la base de datos durante varios meses y sabe que por lo general el flujo de trabajo tiene una duración de unos días, se podría suponer que se trata de una instancia no inicializada que se ha bloqueado.</span><span class="sxs-lookup"><span data-stu-id="c63ee-131">For example, if the instance has been in the database for several months and you know that the workflow typically has a lifetime of a few days, it would be safe to assume that this is an uninitialized instance that had crashed.</span></span>

<span data-ttu-id="c63ee-132">En general, resulta seguro eliminar instancias no conservadas que no están suspendidas ni se han cargado.</span><span class="sxs-lookup"><span data-stu-id="c63ee-132">In general, it is safe to delete non-persisted instances that are not suspended or not loaded.</span></span> <span data-ttu-id="c63ee-133">No debe eliminar **todas** las instancias no persistentes porque este conjunto de instancias incluye instancias que se acaban de crear pero que todavía no se han guardado.</span><span class="sxs-lookup"><span data-stu-id="c63ee-133">You should not delete **all** the non-persisted instances because this instance set includes instances that are just created but are not persisted yet.</span></span> <span data-ttu-id="c63ee-134">Solamente debe eliminar las instancias no conservadas que quedan porque se produjo una excepción en el host del servicio de flujo de trabajo que tenía la instancia cargada o porque se produjo una excepción en la propia instancia.</span><span class="sxs-lookup"><span data-stu-id="c63ee-134">You should only delete non-persisted instances that are left over because the workflow service host that had the instance loaded caused an exception or the instance itself caused an exception.</span></span>

> [!WARNING]
> <span data-ttu-id="c63ee-135">La eliminación de instancias no conservadas del almacén de instancias reduce el tamaño del almacén y puede mejorar el rendimiento de las operaciones del almacén.</span><span class="sxs-lookup"><span data-stu-id="c63ee-135">Deleting non-persisted instances from the instance store decreases the size of the store and may improve the performance of store operations.</span></span>
