---
title: Participantes de persistencia
ms.date: 03/30/2017
ms.assetid: f84d2d5d-1c1b-4f19-be45-65b552d3e9e3
ms.openlocfilehash: 0bff6cc8fafb1832dc4d0e33b754fe3adb81dcf6
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/26/2020
ms.locfileid: "96246113"
---
# <a name="persistence-participants"></a><span data-ttu-id="1fba0-102">Participantes de persistencia</span><span class="sxs-lookup"><span data-stu-id="1fba0-102">Persistence Participants</span></span>

<span data-ttu-id="1fba0-103">Un participante de persistencia puede tomar parte en una operación de persistencia (guardar o cargar) desencadenada por un host de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="1fba0-103">A persistence participant can participate in a persistence operation (Save or Load) triggered by an application host.</span></span> <span data-ttu-id="1fba0-104">[!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)]Se distribuye con dos clases abstractas, **PersistenceParticipant** y **PersistenceIOParticipant**, que puede usar para crear un participante de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-104">The [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] ships with two abstract classes, **PersistenceParticipant** and **PersistenceIOParticipant**, which you can use to create a persistence participant.</span></span> <span data-ttu-id="1fba0-105">Un participante de persistencia se deriva de una de estas clases, implementa los métodos de interés y, a continuación, agrega una instancia de la clase a la colección <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> del objeto <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span><span class="sxs-lookup"><span data-stu-id="1fba0-105">A persistence participant derives from one of these classes, implements the methods of interest, and then adds an instance of the class to the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> collection on the <xref:System.ServiceModel.Activities.WorkflowServiceHost> .</span></span> <span data-ttu-id="1fba0-106">El host de la aplicación puede buscar estas extensiones de flujo de trabajo cuando se conserve una instancia de flujo de trabajo e invocar los métodos apropiados en los participantes de persistencia en los momentos adecuados.</span><span class="sxs-lookup"><span data-stu-id="1fba0-106">The application host may look for such workflow extensions when persisting a workflow instance and invoke appropriate methods on the persistence participants at appropriate times.</span></span>  
  
 <span data-ttu-id="1fba0-107">La siguiente lista describe las tareas realizadas por el subsistema de persistencia en distintas fases de la operación de persistencia (guardar).</span><span class="sxs-lookup"><span data-stu-id="1fba0-107">The following list describes the tasks performed by the persistence subsystem in different stages of the Persist (Save) operation.</span></span> <span data-ttu-id="1fba0-108">Los participantes de persistencia se usan en la tercera y cuarta fase.</span><span class="sxs-lookup"><span data-stu-id="1fba0-108">The persistence participants are used in the third and fourth stages.</span></span> <span data-ttu-id="1fba0-109">Si el participante es un participante de e/s (un participante de persistencia que también participa en operaciones de e/s), el participante también se usa en la sexta fase.</span><span class="sxs-lookup"><span data-stu-id="1fba0-109">If the participant is an I/O participant (a persistence participant that also participates in I/O operations), the participant is also used in the sixth stage.</span></span>  
  
1. <span data-ttu-id="1fba0-110">Recopila valores integrados, incluso el estado del flujo de trabajo, marcadores, variables asignadas y marca de tiempo.</span><span class="sxs-lookup"><span data-stu-id="1fba0-110">Gathers built-in values, including workflow state, bookmarks, mapped variables, and timestamp.</span></span>  
  
2. <span data-ttu-id="1fba0-111">Recopila todos los participantes de persistencia que se agregaron a la colección de extensiones asociada a la instancia de flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="1fba0-111">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
3. <span data-ttu-id="1fba0-112">Invoca el método <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> implementado por todos los participantes de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-112">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method implemented by all persistence participants.</span></span>  
  
4. <span data-ttu-id="1fba0-113">Invoca el método <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> implementado por todos los participantes de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-113">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method implemented by all persistence participants.</span></span>  
  
5. <span data-ttu-id="1fba0-114">Conserve o guarde el flujo de trabajo en el almacén de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-114">Persist or save the workflow into the persistence store.</span></span>  
  
6. <span data-ttu-id="1fba0-115">Invoca el <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> método en todos los participantes de e/s de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-115">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> method on all of the persistence I/O participants.</span></span> <span data-ttu-id="1fba0-116">Si el participante no es un participante de e/s, se omitirá esta tarea.</span><span class="sxs-lookup"><span data-stu-id="1fba0-116">If the participant is not an I/O participant, this task is skipped.</span></span> <span data-ttu-id="1fba0-117">Si el episodio de persistencia es transaccional, la transacción se proporciona en la propiedad Transaction.Current.</span><span class="sxs-lookup"><span data-stu-id="1fba0-117">If the persistence episode is transactional, the transaction is provided in Transaction.Current property.</span></span>  
  
7. <span data-ttu-id="1fba0-118">Espera a que se completen todos los participantes de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-118">Waits for all persistence participants to complete.</span></span> <span data-ttu-id="1fba0-119">Si todos los participantes consiguen almacenar datos de instancia, confirma la transacción.</span><span class="sxs-lookup"><span data-stu-id="1fba0-119">If all the participants succeed in persisting instance data, commits the transaction.</span></span>  
  
 <span data-ttu-id="1fba0-120">Un participante de persistencia deriva de la clase **PersistenceParticipant** y puede implementar los métodos **CollectValues** y **MapValues** .</span><span class="sxs-lookup"><span data-stu-id="1fba0-120">A persistence participant derives from the **PersistenceParticipant** class and may implement the **CollectValues** and **MapValues** methods.</span></span> <span data-ttu-id="1fba0-121">Un participante de e/s de persistencia deriva de la clase **PersistenceIOParticipant** y puede implementar el método **método beginonsave** además de implementar los métodos **CollectValues** y **MapValues** .</span><span class="sxs-lookup"><span data-stu-id="1fba0-121">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnSave** method in addition to implementing the **CollectValues** and **MapValues** methods.</span></span>  
  
 <span data-ttu-id="1fba0-122">Se completa cada fase antes de que comience la siguiente.</span><span class="sxs-lookup"><span data-stu-id="1fba0-122">Each stage is completed before the next stage begins.</span></span> <span data-ttu-id="1fba0-123">Por ejemplo, los valores se recopilan de **todos los** participantes de persistencia en la primera fase.</span><span class="sxs-lookup"><span data-stu-id="1fba0-123">For example, values are collected from **all** persistence participants in the first stage.</span></span> <span data-ttu-id="1fba0-124">A continuación, se proporcionarán para su asignación todos los valores recopilados en la primera fase a todos los participantes de persistencia en la segunda fase.</span><span class="sxs-lookup"><span data-stu-id="1fba0-124">Then all the values collected in the first stage are provided to all persistence participants in the second stage for mapping.</span></span> <span data-ttu-id="1fba0-125">A continuación, todos los valores recopilados y asignados en la primera y segunda fase se proporcionan al proveedor de persistencia en la tercera fase, etc.</span><span class="sxs-lookup"><span data-stu-id="1fba0-125">Then all the values collected and mapped in the first and second stages are provided to the persistence provider in the third stage, and so on.</span></span>  
  
 <span data-ttu-id="1fba0-126">La siguiente lista describe las tareas realizadas por el subsistema de persistencia en distintas fases de la operación de carga.</span><span class="sxs-lookup"><span data-stu-id="1fba0-126">The following list describes the tasks performed by the persistence subsystem in different stages of the Load operation.</span></span> <span data-ttu-id="1fba0-127">Los participantes de persistencia se usan en la cuarta fase.</span><span class="sxs-lookup"><span data-stu-id="1fba0-127">The persistence participants are used in the fourth stage.</span></span> <span data-ttu-id="1fba0-128">Los participantes de e/s de persistencia (participantes de persistencia que también participan en operaciones de e/s) también se usan en la tercera fase.</span><span class="sxs-lookup"><span data-stu-id="1fba0-128">The persistence I/O participants (persistence participants that also participate in I/O operations) are also used in the third stage.</span></span>  
  
1. <span data-ttu-id="1fba0-129">Recopila todos los participantes de persistencia que se agregaron a la colección de extensiones asociada a la instancia de flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="1fba0-129">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
2. <span data-ttu-id="1fba0-130">Carga el flujo de trabajo del almacén de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-130">Loads the workflow from the persistence store.</span></span>  
  
3. <span data-ttu-id="1fba0-131">Invoca <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> en todos los participantes de e/s de persistencia y espera a que se completen todos los participantes de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-131">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> on all persistence I/O participants and waits for all the persistence participants to complete.</span></span> <span data-ttu-id="1fba0-132">Si el episodio de persistencia es transaccional, la transacción se proporciona en la propiedad Transaction.Current.</span><span class="sxs-lookup"><span data-stu-id="1fba0-132">If the persistence episode is transactional, the transaction is provided in Transaction.Current.</span></span>  
  
4. <span data-ttu-id="1fba0-133">Carga la instancia de flujo de trabajo en memoria según los datos recuperados del almacén de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-133">Loads the workflow instance in memory based on the data retrieved from the persistence store.</span></span>  
  
5. <span data-ttu-id="1fba0-134">Invoca <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> en cada participante de persistencia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-134">Invokes <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> on each persistence participant.</span></span>  
  
 <span data-ttu-id="1fba0-135">Un participante de persistencia deriva de la clase **PersistenceParticipant** y puede implementar el método **PublishValues** .</span><span class="sxs-lookup"><span data-stu-id="1fba0-135">A persistence participant derives from the **PersistenceParticipant** class and may implement the **PublishValues** method.</span></span> <span data-ttu-id="1fba0-136">Un participante de e/s de persistencia deriva de la clase **PersistenceIOParticipant** y puede implementar el método **BeginOnLoad** además de implementar el método **PublishValues** .</span><span class="sxs-lookup"><span data-stu-id="1fba0-136">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnLoad** method in addition to implementing the **PublishValues** method.</span></span>  
  
 <span data-ttu-id="1fba0-137">Al cargar una instancia de flujo de trabajo el proveedor de persistencia crea un bloqueo en esa instancia.</span><span class="sxs-lookup"><span data-stu-id="1fba0-137">When loading a workflow instance the persistence provider creates a lock on that instance.</span></span> <span data-ttu-id="1fba0-138">Esto evita que más de un host cargue la instancia en un escenario de múltiples nodos.</span><span class="sxs-lookup"><span data-stu-id="1fba0-138">This prevents the instance from being loaded by more than one host in a multi-node scenario.</span></span> <span data-ttu-id="1fba0-139">Si intenta cargar una instancia de flujo de trabajo que ha estado bloqueada verá una excepción como la siguiente: Excepción "System.ServiceModel.Persistence.InstanceLockException: La operación solicitada no se pudo completar porque no fue posible realizar el bloqueo de la instancia '00000000-0000-0000-0000-000000000000'".</span><span class="sxs-lookup"><span data-stu-id="1fba0-139">If you attempt to load a workflow instance that has been locked you will see an exception like the following: The exception " System.ServiceModel.Persistence.InstanceLockException: The requested operation could not complete because the lock for instance '00000000-0000-0000-0000-000000000000' could not be acquired".</span></span> <span data-ttu-id="1fba0-140">Este error se debe a una de las siguientes causas:</span><span class="sxs-lookup"><span data-stu-id="1fba0-140">This error is caused when one of the following occurs:</span></span>  
  
- <span data-ttu-id="1fba0-141">En un escenario de múltiples nodos, la instancia la carga otro host.</span><span class="sxs-lookup"><span data-stu-id="1fba0-141">In a multi-node scenario the instance is loaded by another host.</span></span>  <span data-ttu-id="1fba0-142">Hay varias maneras diferentes para resolver estos tipos de conflictos: reenviar el procesamiento el nodo que posee el bloqueo y reintentarlo, o forzar la carga, lo que hará que el otro host no pueda guardar el trabajo.</span><span class="sxs-lookup"><span data-stu-id="1fba0-142">There are a few different ways to resolve these types of conflicts: forward the processing to the node which owns the lock and retry, or force the load which will cause the other host to be unable to save their work.</span></span>  
  
- <span data-ttu-id="1fba0-143">En un escenario de un solo nodo y el host está bloqueado.</span><span class="sxs-lookup"><span data-stu-id="1fba0-143">In a single-node scenario and the host crashed.</span></span>  <span data-ttu-id="1fba0-144">Cuando el host se inicia de nuevo (un reciclaje de proceso o creando un nuevo generador de proveedores de persistencia), el nuevo host intentar cargar una instancia que ya está bloqueada por el host antiguo porque el bloqueo no ha expirado todavía.</span><span class="sxs-lookup"><span data-stu-id="1fba0-144">When the host starts up again (a process recycle or creating a new persistence provider factory) the new host attempts to load an instance which is still locked by the old host because the lock hasn't expired yet.</span></span>  
  
- <span data-ttu-id="1fba0-145">En un escenario de un solo nodo y la instancia en cuestión se anuló en algún momento y se creó una nueva instancia del proveedor de persistencia que tiene otro identificador de host.</span><span class="sxs-lookup"><span data-stu-id="1fba0-145">In a single-node scenario and the instance in question was aborted at some point and a new persistence provider instance is created which has a different host ID.</span></span>  
  
 <span data-ttu-id="1fba0-146">El valor de tiempo de espera de bloqueo tiene un valor predeterminado de 5 minutos; puede especificar un valor diferente de tiempo de espera al llamar a <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.</span><span class="sxs-lookup"><span data-stu-id="1fba0-146">The lock timeout value has a default value of 5 minutes, you can specify a different timeout value when calling <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="1fba0-147">En esta sección</span><span class="sxs-lookup"><span data-stu-id="1fba0-147">In This Section</span></span>  
  
- [<span data-ttu-id="1fba0-148">Procedimiento para crear un participante de persistencia personalizado</span><span class="sxs-lookup"><span data-stu-id="1fba0-148">How to: Create a Custom Persistence Participant</span></span>](how-to-create-a-custom-persistence-participant.md)  
  
## <a name="see-also"></a><span data-ttu-id="1fba0-149">Vea también</span><span class="sxs-lookup"><span data-stu-id="1fba0-149">See also</span></span>

- [<span data-ttu-id="1fba0-150">Extensibilidad de almacén</span><span class="sxs-lookup"><span data-stu-id="1fba0-150">Store Extensibility</span></span>](store-extensibility.md)
